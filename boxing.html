<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Interval Coach | Dr. Pearson-Noseworthy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent-blue: #3b82f6;
            --accent-green: #22c55e;
            --accent-orange: #f97316;
            --accent-purple: #a855f7;
            --accent-red: #ef4444;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'DM Sans', system-ui, sans-serif; 
            overscroll-behavior-y: contain;
            background-color: #0f172a;
        }

        .font-mono-display { font-family: 'Space Mono', monospace; }

        /* Glassmorphism */
        .glass-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .glass-inset {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Animated Progress Ring */
        .timer-ring {
            transition: stroke-dashoffset 0.2s linear, stroke 0.3s ease;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }

        /* Button Grid Styles */
        .btn-select {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255,255,255,0.1);
            color: #94a3b8;
            transition: all 0.2s;
        }
        .btn-select.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body class="text-slate-200 min-h-screen flex flex-col items-center justify-center p-4">

    <!-- SETUP SCREEN -->
    <div id="setup-screen" class="w-full max-w-md space-y-5 py-4">
        <div class="text-center mb-2">
            <h1 class="text-3xl font-bold text-white tracking-tight mb-1">12 Rounds</h1>
            <p class="text-slate-400 text-sm font-medium uppercase tracking-[0.2em]">Dr. Pearson-Noseworthy</p>
        </div>

        <div class="glass-card p-5 rounded-[2rem] space-y-5">
            
            <!-- Mode Selection (Solo vs Wife) -->
            <div class="flex p-1 bg-slate-800/50 rounded-xl">
                <button id="mode-solo" class="flex-1 py-3 rounded-lg text-xs font-bold uppercase tracking-wider transition-all bg-blue-600 text-white shadow-md">Solo</button>
                <button id="mode-wife" class="flex-1 py-3 rounded-lg text-xs font-bold uppercase tracking-wider transition-all text-slate-400 hover:text-white">With Wife</button>
            </div>

            <div id="rest-info" class="text-center bg-slate-800/30 p-2 rounded-lg border border-slate-700/30">
                <p class="text-[10px] text-orange-300 font-bold uppercase tracking-widest">Progressive Rest</p>
                <p class="text-xs text-slate-400">Starts at 30s, adds 5s each round.</p>
            </div>

            <!-- Controls Grid -->
            <div class="space-y-4">
                
                <!-- Randomiser Toggle -->
                <div class="flex items-center justify-between px-1">
                    <div>
                        <span class="text-sm font-bold text-white block">Randomise Focus</span>
                        <span class="text-[10px] text-slate-400">Generates unique themes (Rnds 2-11)</span>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="in-random" class="sr-only peer">
                        <div class="w-12 h-6 bg-slate-800 rounded-full peer peer-checked:bg-purple-600 peer-checked:after:translate-x-6 after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all"></div>
                    </label>
                </div>

                <hr class="border-slate-700/50">

                <!-- Rounds Grid -->
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block ml-1">Total Rounds</label>
                    <div class="grid grid-cols-6 gap-2" id="grid-rounds">
                        <!-- Generated by JS -->
                    </div>
                </div>

                <!-- Work Duration Buttons -->
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block ml-1">Work Time</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button class="btn-select py-3 rounded-xl text-sm font-mono-display" onclick="selectWork(30, this)">30s</button>
                        <button class="btn-select py-3 rounded-xl text-sm font-mono-display" onclick="selectWork(45, this)">45s</button>
                        <button class="btn-select active py-3 rounded-xl text-sm font-mono-display" onclick="selectWork(60, this)">60s</button>
                    </div>
                </div>

            </div>
        </div>

        <!-- Preview Section -->
        <div class="glass-card p-4 rounded-[1.5rem] space-y-2">
            <h3 class="font-bold text-white text-xs uppercase tracking-widest ml-1 opacity-70">Session Preview</h3>
            <div id="round-preview" class="max-h-32 overflow-y-auto space-y-1.5 pr-1 custom-scrollbar">
                <!-- JS Populated -->
            </div>
        </div>

        <button id="btn-start" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-2xl text-lg shadow-[0_0_20px_rgba(59,130,246,0.4)] active:scale-[0.98] transition-all">
            Begin Session
        </button>
    </div>

    <!-- TIMER SCREEN -->
    <div id="timer-screen" class="hidden w-full max-w-md flex-col items-center justify-between h-[90vh] py-8">
        
        <div class="w-full px-6 flex justify-between items-center">
            <div class="space-y-1">
                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em]" id="round-label">Round</p>
                <div class="flex items-baseline space-x-2">
                    <span id="current-round" class="text-4xl font-black font-mono-display text-white">1</span>
                    <span class="text-slate-600 text-xl font-bold">/</span>
                    <span id="total-rounds" class="text-slate-600 text-xl font-bold">12</span>
                </div>
            </div>
            <div id="phase-badge" class="px-4 py-2 rounded-full border text-[10px] font-black uppercase tracking-widest transition-colors duration-500">
                Ready
            </div>
        </div>

        <div class="relative w-80 h-80 flex items-center justify-center">
            <svg class="absolute inset-0 w-full h-full" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="46" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="4" />
                <circle id="progress-ring" class="timer-ring" cx="50" cy="50" r="46" fill="none" stroke="#f97316" stroke-width="4" stroke-linecap="round" stroke-dasharray="289" stroke-dashoffset="0" />
            </svg>
            
            <div class="text-center z-10">
                <div id="timer-display" class="text-7xl font-black font-mono-display text-white tracking-tighter">00:00</div>
                <div id="next-up" class="text-[10px] text-slate-500 mt-4 font-bold uppercase tracking-widest h-4"></div>
            </div>
        </div>

        <!-- Coach Callout Area -->
        <div id="callout-card" class="w-full glass-card h-32 rounded-[2rem] flex items-center justify-center px-8 transition-all duration-300 opacity-0 transform translate-y-4">
            <div class="text-center">
                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2" id="callout-label">Coach</p>
                <div id="current-callout" class="text-3xl font-black text-white uppercase tracking-tight leading-none">--</div>
            </div>
        </div>

        <div class="w-full px-4 grid grid-cols-2 gap-4">
            <button id="btn-pause" class="bg-slate-800 hover:bg-slate-700 text-white font-bold py-5 rounded-2xl transition-all active:scale-95">
                Pause
            </button>
            <button id="btn-end" class="bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/30 font-bold py-5 rounded-2xl transition-all active:scale-95">
                End
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- DATA LIBRARIES ---
            
            // 1. The Fixed Program (Dr. P's Class)
            const PROGRAM_12_ROUNDS = [
                { name: "Warm Up: Jab & Move", moves: ['Jab', '1-2', 'Move', 'Breathe', 'Light 1-2', 'Shake out'] },
                { name: "1-2-3 (Straight-Straight-Hook)", moves: ['1-2-3', 'Jab-Cross-Hook', 'Jab-Uppercut-Hook', 'Cross-Hook-Cross'] },
                { name: "Uppercut then Hook", moves: ['Lead Uppercut-Hook', 'Rear Uppercut-Lead Hook', 'Uppercut-Hook', '5-3', '6-2'] },
                { name: "4 Punch Combos", moves: ['1-2-3-2', '1-2-5-2', 'Jab-Cross-Hook-Cross', '1-1-2-3'] },
                { name: "Power Singles", moves: ['Power Jab', 'Hard Cross', 'Big Hook', 'Overhand', 'Body Shot'] },
                { name: "Light 1-2s (Speed)", moves: ['Fast 1-2', 'Touch-Touch', 'Jab-Cross (Fast)', 'High-Low'] },
                { name: "Double Jab + Cross", moves: ['1-1-2', '1-1-Rear Hook', '1-1-Overhand', 'Jab-Jab-Cross'] },
                { name: "3 Punch Speed", moves: ['Fast 1-2-3', 'Touch-Touch-Bang', 'Speed 3s'] },
                { name: "Hooks Only", moves: ['Lead Hook', 'Rear Hook', 'Body Hook', '3-4', 'Head-Body'] },
                { name: "Heavy 1-2s", moves: ['Hard 1-2', 'Power 1-2', 'Cross-Hook', 'Hook-Cross'] },
                { name: "Uppercut, Hook, Hook", moves: ['Uppercut-Hook-Hook', '5-3-4', '6-3-2'] },
                { name: "Constant Burnout", moves: ['Non-stop', '1-2-1-2', 'Burnout', 'Speed', 'Go Go Go'] }
            ];

            // 2. The Massive Random Pool (Descriptive for Beginners)
            const ROUND_POOL = [
                // BASICS
                { name: "Jab Only", moves: ['Jab', 'Double Jab', 'Jab-Head', 'Jab-Body', 'Power Jab'] },
                { name: "Jab & Cross (1-2)", moves: ['1-2', 'Fast 1-2', 'Hard 1-2', '1-Body 2'] },
                { name: "Double Jab & Cross", moves: ['1-1-2', 'Jab-Jab-Cross', '1-1-Body 2'] },
                { name: "1-2 then Hook", moves: ['1-2-3', 'Jab-Cross-Hook', '1-2-Lead Hook'] },
                { name: "1-2 then Uppercut", moves: ['1-2-5', '1-2-6', 'Jab-Cross-Lead Uppercut', 'Jab-Cross-Rear Uppercut'] },
                
                // PUNCH TYPES
                { name: "4 Straight Punches", moves: ['1-2-1-2', 'Jab-Cross-Jab-Cross', '4 Fast Straights'] },
                // "Uppercuts Only" removed as requested for bag compatibility
                { name: "Hooks Only", moves: ['Lead Hook', 'Rear Hook', 'Left Hook-Right Hook', 'Check Hook'] },
                { name: "Body Shots Only", moves: ['Lead Body Hook', 'Rear Body Hook', 'Jab Low', 'Cross Low'] },
                { name: "Power Singles", moves: ['Hard Cross', 'Big Hook', 'Power Jab', 'Hard Uppercut'] },

                // DEFENSE & MOVEMENT
                { name: "1-2, Slip, Cross", moves: ['1-2-Slip-2', 'Jab-Cross-Slip-Cross'] },
                { name: "1-2, Roll, Cross", moves: ['1-2-Roll-2', 'Jab-Cross-Roll Under-Cross'] },
                { name: "Step Back & Cross", moves: ['1-2-Step Back', 'Jab-Back-Cross', 'Touch-Back-Bang'] },
                { name: "Pivot & Punch", moves: ['1-2-Pivot', 'Jab-Pivot-Cross', 'Pivot-Hook'] },
                
                // COMBINATIONS
                { name: "Jab, Cross, Hook, Cross", moves: ['1-2-3-2', 'Jab-Cross-Hook-Cross'] },
                { name: "Lead Hook, Rear Straight", moves: ['3-2', 'Hook-Cross', 'Check Hook-Cross'] },
                { name: "High & Low (Head & Body)", moves: ['Jab High-Cross Low', '1-2 High-Hook Low', 'Head-Body-Head'] },
                { name: "3 Punch Combos", moves: ['1-2-3', '2-3-2', '3-2-3', '5-2-3'] },
                { name: "Non-stop Light Speed", moves: ['1-2-1-2 Light', 'Speed punches', 'Fast Hands'] }
            ];

            // --- APP STATE ---
            let settings = { 
                mode: 'solo', // 'solo' or 'wife'
                rounds: 12, 
                work: 60,
                restBase: 30, // Starting rest
                randomiseMiddle: false
            };
            
            let session = { 
                active: false, 
                paused: false, 
                phase: 'ready', 
                round: 1, 
                time: 10, 
                total: 10, 
                timer: null, 
                callTimer: 0,
                lastMove: '',
                plan: [] // Array of { name, moves }
            };
            
            let audioCtx = null;
            let wakeLock = null;

            // --- DOM SELECTORS ---
            const ui = {
                setup: document.getElementById('setup-screen'),
                timer: document.getElementById('timer-screen'),
                
                // Controls
                modeSolo: document.getElementById('mode-solo'),
                modeWife: document.getElementById('mode-wife'),
                restInfo: document.getElementById('rest-info'),
                inRandom: document.getElementById('in-random'),
                gridRounds: document.getElementById('grid-rounds'),
                
                // Display
                previewList: document.getElementById('round-preview'),
                
                // Timer
                ring: document.getElementById('progress-ring'),
                badge: document.getElementById('phase-badge'),
                calloutCard: document.getElementById('callout-card'),
                timerDisplay: document.getElementById('timer-display'),
                roundCur: document.getElementById('current-round'),
                roundTot: document.getElementById('total-rounds'),
                nextUp: document.getElementById('next-up'),
                callLabel: document.getElementById('callout-label'),
                callText: document.getElementById('current-callout'),
                
                // Buttons
                btnStart: document.getElementById('btn-start'),
                btnPause: document.getElementById('btn-pause'),
                btnEnd: document.getElementById('btn-end')
            };

            const format = (s) => {
                const m = Math.floor(s / 60).toString().padStart(2, '0');
                const sec = (Math.max(0, s) % 60).toString().padStart(2, '0');
                return `${m}:${sec}`;
            };

            // ---- UI GENERATION ----
            for (let i = 1; i <= 12; i++) {
                const btn = document.createElement('button');
                btn.className = `btn-select py-2 rounded-lg text-xs font-bold ${i === 12 ? 'active' : ''}`;
                btn.innerText = i;
                btn.onclick = () => selectRound(i, btn);
                ui.gridRounds.appendChild(btn);
            }

            window.selectRound = (n, el) => {
                settings.rounds = n;
                Array.from(ui.gridRounds.children).forEach(b => b.classList.remove('active'));
                el.classList.add('active');
                generateSessionPlan();
            };

            window.selectWork = (n, el) => {
                settings.work = n;
                Array.from(el.parentNode.children).forEach(b => b.classList.remove('active'));
                el.classList.add('active');
            };

            // ---- MODE SWITCHING ----
            function setMode(mode) {
                settings.mode = mode;
                if (mode === 'solo') {
                    ui.modeSolo.className = "flex-1 py-3 rounded-lg text-xs font-bold uppercase tracking-wider transition-all bg-blue-600 text-white shadow-md";
                    ui.modeWife.className = "flex-1 py-3 rounded-lg text-xs font-bold uppercase tracking-wider transition-all text-slate-400 hover:text-white";
                    ui.restInfo.innerHTML = `<p class="text-[10px] text-orange-300 font-bold uppercase tracking-widest">Progressive Rest</p><p class="text-xs text-slate-400">Starts at 30s, +5s each round.</p>`;
                } else {
                    ui.modeWife.className = "flex-1 py-3 rounded-lg text-xs font-bold uppercase tracking-wider transition-all bg-purple-600 text-white shadow-md";
                    ui.modeSolo.className = "flex-1 py-3 rounded-lg text-xs font-bold uppercase tracking-wider transition-all text-slate-400 hover:text-white";
                    ui.restInfo.innerHTML = `<p class="text-[10px] text-purple-300 font-bold uppercase tracking-widest">Partner Mode</p><p class="text-xs text-slate-400">2x Rounds. No rest timer (You go, I go).</p>`;
                }
                generateSessionPlan();
            }
            
            ui.modeSolo.onclick = () => setMode('solo');
            ui.modeWife.onclick = () => setMode('wife');
            ui.inRandom.onchange = (e) => {
                settings.randomiseMiddle = e.target.checked;
                generateSessionPlan();
            };

            // ---- SESSION GENERATION ----
            function generateSessionPlan() {
                session.plan = [];
                const totalRounds = settings.rounds; // Base rounds (1-12)

                // Clone pool to allow splicing (no duplicates)
                let tempPool = [...ROUND_POOL];

                for (let i = 0; i < totalRounds; i++) {
                    let roundObj = null;

                    // Logic: Round 1 is always Warmup. Round N is always Constant.
                    // If RandomiseMiddle is OFF: Use Fixed Program.
                    // If RandomiseMiddle is ON: Use Pool for 2 -> N-1.

                    const isFirst = (i === 0);
                    const isLast = (i === totalRounds - 1);

                    if (settings.randomiseMiddle) {
                        if (isFirst) {
                            roundObj = PROGRAM_12_ROUNDS[0]; // Warm Up
                        } else if (isLast) {
                            roundObj = PROGRAM_12_ROUNDS[11]; // Constant
                        } else {
                            // Pick random from pool
                            if (tempPool.length === 0) tempPool = [...ROUND_POOL]; // Refill if exhausted
                            const idx = Math.floor(Math.random() * tempPool.length);
                            roundObj = tempPool[idx];
                            tempPool.splice(idx, 1); // Remove used
                        }
                    } else {
                        // Fixed Program
                        roundObj = PROGRAM_12_ROUNDS[i % PROGRAM_12_ROUNDS.length];
                    }
                    session.plan.push(roundObj);
                }
                updatePreview();
            }

            // ---- PREVIEW RENDER ----
            function updatePreview() {
                ui.previewList.innerHTML = '';
                const displayRounds = settings.mode === 'wife' ? settings.rounds * 2 : settings.rounds;

                for (let i = 1; i <= displayRounds; i++) {
                    // Logic:
                    // Solo: i-1 maps directly to plan index.
                    // Wife: (i-1)/2 maps to plan index (R1&2=Plan[0], R3&4=Plan[1])
                    const planIdx = settings.mode === 'wife' ? Math.floor((i-1)/2) : i-1;
                    const roundData = session.plan[planIdx];

                    let title = `Round ${i}`;
                    let subtitle = roundData.name;
                    let colorClass = "text-slate-300";

                    if (settings.mode === 'wife') {
                        const isYou = (i % 2 !== 0);
                        title = isYou ? "YOU" : "PARTNER";
                        colorClass = isYou ? "text-green-400" : "text-purple-400";
                    } else {
                        title = `${i}. ${subtitle}`;
                        // Progressive rest info for solo
                        const restTime = settings.restBase + ((i-1)*5);
                        subtitle = i < displayRounds ? `Rest: ${restTime}s` : 'Finish';
                    }

                    const div = document.createElement('div');
                    div.className = "text-[10px] p-2 rounded bg-slate-800/40 border border-slate-700/50 flex justify-between items-center";
                    div.innerHTML = `
                        <span class="font-bold ${colorClass}">${title}</span>
                        <span class="text-slate-500 truncate ml-2 max-w-[150px] text-right">${settings.mode === 'wife' ? subtitle : subtitle}</span>
                    `;
                    ui.previewList.appendChild(div);
                }
            }

            // ---- AUDIO ----
            function initAudio() {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') audioCtx.resume();
            }

            function playBell() {
                if (!audioCtx) return;
                const now = audioCtx.currentTime;
                [440, 880, 1200].forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = i === 0 ? 'sine' : 'triangle';
                    osc.frequency.setValueAtTime(freq, now);
                    gain.connect(audioCtx.destination);
                    osc.connect(gain);
                    gain.gain.setValueAtTime(0.5 / (i+1), now);
                    gain.gain.exponentialRampToValueAtTime(0.0001, now + (i === 0 ? 2 : 1));
                    osc.start(now);
                    osc.stop(now + 2);
                });
            }

            function playBeep(high = false) {
                if (!audioCtx) return;
                const now = audioCtx.currentTime;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(high ? 1000 : 600, now);
                gain.connect(audioCtx.destination);
                osc.connect(gain);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            }

            function speak(text) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.rate = 1.2; u.pitch = 1; u.lang = 'en-GB';
                window.speechSynthesis.speak(u);
            }

            // ---- SESSION RUNTIME ----
            const setPhase = (phase) => {
                session.phase = phase;
                ui.calloutCard.classList.add('opacity-0', 'translate-y-4');
                
                if (phase === 'ready') {
                    session.time = 20; 
                    session.total = 20;
                    ui.badge.innerText = "Prepare";
                    ui.badge.className = "px-4 py-2 rounded-full border border-orange-500/30 bg-orange-500/10 text-orange-400 text-[10px] font-black uppercase tracking-widest";
                    ui.ring.style.stroke = "#f97316"; 
                    ui.nextUp.innerText = "Next: " + session.plan[0].name;
                    
                } else if (phase === 'work') {
                    session.time = settings.work; session.total = settings.work;
                    playBell();
                    ui.calloutCard.classList.remove('opacity-0', 'translate-y-4');
                    
                    // Identify current round theme from Plan
                    const planIdx = settings.mode === 'wife' ? Math.floor((session.round - 1) / 2) : session.round - 1;
                    const roundData = session.plan[planIdx];
                    
                    // Store active move list
                    session.currentMoves = roundData.moves;
                    
                    // Label Logic
                    if (settings.mode === 'wife') {
                        const isYou = (session.round % 2 !== 0);
                        ui.callLabel.innerText = isYou ? `YOU • ${roundData.name}` : `PARTNER • ${roundData.name}`;
                        
                        if (isYou) {
                            ui.badge.innerText = "YOU: Work";
                            ui.badge.className = "px-4 py-2 rounded-full border border-green-500/30 bg-green-500/10 text-green-400 text-[10px] font-black uppercase tracking-widest";
                            ui.ring.style.stroke = "#22c55e";
                        } else {
                            ui.badge.innerText = "PARTNER: Work";
                            ui.badge.className = "px-4 py-2 rounded-full border border-purple-500/30 bg-purple-500/10 text-purple-400 text-[10px] font-black uppercase tracking-widest";
                            ui.ring.style.stroke = "#a855f7";
                        }
                    } else {
                        ui.callLabel.innerText = roundData.name;
                        ui.badge.innerText = "Work";
                        ui.badge.className = "px-4 py-2 rounded-full border border-green-500/30 bg-green-500/10 text-green-400 text-[10px] font-black uppercase tracking-widest";
                        ui.ring.style.stroke = "#22c55e";
                    }

                    ui.roundCur.innerText = session.round;
                    ui.nextUp.innerText = "";
                    
                    // Announce theme & start
                    speak(roundData.name);
                    triggerCallout(true);

                } else if (phase === 'rest') {
                    // Solo Progressive Rest
                    const restDuration = settings.restBase + ((session.round - 1) * 5);
                    session.time = restDuration; session.total = restDuration;
                    
                    ui.badge.innerText = `Rest (${restDuration}s)`;
                    ui.badge.className = "px-4 py-2 rounded-full border border-red-500/30 bg-red-500/10 text-red-500 text-[10px] font-black uppercase tracking-widest";
                    ui.ring.style.stroke = "#ef4444";
                    
                    // Next Up Logic
                    if (session.round < settings.rounds) {
                        const nextName = session.plan[session.round].name;
                        ui.nextUp.innerText = `Up Next: ${nextName}`;
                    } else {
                        ui.nextUp.innerText = "Final Round Complete";
                    }
                    playBell();
                }
                updateUI();
            };

            function triggerCallout(first = false) {
                if (session.phase !== 'work') return;
                
                const moveList = session.currentMoves;
                let move = moveList[Math.floor(Math.random() * moveList.length)];
                
                if (first) {
                    ui.callText.innerText = "GO";
                } else {
                    if (move === session.lastMove && moveList.length > 1) {
                         move = moveList[(moveList.indexOf(move) + 1) % moveList.length];
                    }
                    session.lastMove = move;

                    ui.callText.classList.add('scale-90', 'opacity-50');
                    setTimeout(() => {
                        ui.callText.innerText = move;
                        ui.callText.classList.remove('scale-90', 'opacity-50');
                        speak(move);
                    }, 100);
                }

                // Callout timing
                const min = 3, max = 5;
                session.callTimer = Math.floor(Math.random() * (max - min + 1) + min);
            }

            function updateUI() {
                ui.timerDisplay.innerText = format(session.time);
                const circumference = 289;
                const offset = circumference - ((session.time / session.total) * circumference);
                ui.ring.style.strokeDashoffset = offset;
            }

            function run() {
                session.timer = setInterval(() => {
                    if (session.paused) return;
                    session.time--;
                    
                    if (session.time <= 3 && session.time > 0) playBeep(session.time === 1);
                    
                    if (session.time < 0) {
                        const maxRounds = settings.mode === 'wife' ? settings.rounds * 2 : settings.rounds;

                        if (session.phase === 'ready') setPhase('work');
                        else if (session.phase === 'work') {
                            if (session.round >= maxRounds) end();
                            else {
                                if (settings.mode === 'wife') {
                                    session.round++;
                                    setPhase('work');
                                } else {
                                    setPhase('rest');
                                }
                            }
                        } else if (session.phase === 'rest') {
                            session.round++;
                            setPhase('work');
                        }
                    }

                    if (session.phase === 'work') {
                        session.callTimer--;
                        if (session.callTimer <= 0) triggerCallout();
                    }
                    updateUI();
                }, 1000);
            }

            function end() {
                session.active = false;
                clearInterval(session.timer);
                if (wakeLock) wakeLock.release();
                window.speechSynthesis.cancel();
                ui.timer.classList.add('hidden');
                ui.setup.classList.remove('hidden');
            }

            // ---- INIT ----
            ui.btnStart.onclick = async () => {
                initAudio();
                try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch(e){}

                ui.setup.classList.add('hidden');
                ui.timer.classList.remove('hidden');
                ui.timer.classList.add('flex');
                
                const totalDisplay = settings.mode === 'wife' ? settings.rounds * 2 : settings.rounds;
                ui.roundTot.innerText = totalDisplay;

                session.round = 1;
                session.active = true;
                setPhase('ready');
                run();
            };

            ui.btnEnd.onclick = end;

            ui.btnPause.onclick = () => {
                session.paused = !session.paused;
                ui.btnPause.innerText = session.paused ? "Resume" : "Pause";
                ui.btnPause.classList.toggle('bg-blue-600');
                ui.btnPause.classList.toggle('bg-slate-800');
            };

            // Run Init Logic
            generateSessionPlan();
        });
    </script>
</body>
</html>

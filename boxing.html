<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Interval Coach | Dr. Pearson-Noseworthy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent-blue: #3b82f6;
            --accent-green: #22c55e;
            --accent-orange: #f97316;
            --accent-purple: #a855f7;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'DM Sans', system-ui, sans-serif; 
            overscroll-behavior-y: contain;
            background-color: #0f172a;
        }

        .font-mono-display { font-family: 'Space Mono', monospace; }

        /* Advanced Glassmorphism */
        .glass-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .glass-inset {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Animated Progress Ring */
        .timer-ring {
            transition: stroke-dashoffset 0.2s linear;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        /* Custom Range Input */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: #334155;
            border-radius: 2px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
            cursor: pointer;
            border: 2px solid #3b82f6;
            transition: transform 0.1s;
        }
        input[type="range"]::-webkit-slider-thumb:active {
            transform: scale(1.2);
        }

        .phase-transition {
            animation: phaseIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes phaseIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .hidden { display: none !important; }
        
        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #68D391;
        }
    </style>
</head>
<body class="text-slate-200 min-h-screen flex flex-col items-center justify-center p-4">

    <!-- SETUP SCREEN -->
    <div id="setup-screen" class="w-full max-w-md space-y-6">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-white tracking-tight mb-1">Interval Coach</h1>
            <p class="text-slate-400 text-sm font-medium uppercase tracking-[0.2em]">Dr. Pearson-Noseworthy</p>
        </div>

        <div class="glass-card p-6 rounded-[2rem] space-y-6">
            
            <!-- Mode Selection -->
            <div class="flex p-1 bg-slate-800/50 rounded-xl mb-4">
                <button id="mode-freestyle" class="flex-1 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all bg-slate-700 text-white shadow-md">Freestyle</button>
                <button id="mode-program" class="flex-1 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all text-slate-400 hover:text-white">12 Round Class</button>
            </div>

            <!-- Partner Mode Toggle -->
            <div class="flex items-center justify-between px-2">
                <div>
                    <span class="text-sm font-bold text-white block">Partner Mode</span>
                    <span class="text-[10px] text-slate-400">Doubles rounds (You go, I go)</span>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="in-partner" class="sr-only peer">
                    <div class="w-12 h-6 bg-slate-800 rounded-full peer peer-checked:bg-blue-600 peer-checked:after:translate-x-6 after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all"></div>
                </label>
            </div>

            <hr class="border-slate-700/50 my-2">

            <!-- Rounds Control -->
            <div class="space-y-3" id="group-rounds">
                <div class="flex justify-between items-end">
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Rounds</label>
                    <span id="disp-rounds" class="font-mono-display text-2xl text-blue-400 font-bold">12</span>
                </div>
                <input type="range" min="1" max="24" value="12" id="in-rounds">
            </div>

            <!-- Work Control -->
            <div class="space-y-3">
                <div class="flex justify-between items-end">
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Work Duration</label>
                    <span id="disp-work" class="font-mono-display text-2xl text-green-400 font-bold">03:00</span>
                </div>
                <input type="range" min="10" max="600" step="10" value="180" id="in-work">
            </div>

            <!-- Rest Control -->
            <div class="space-y-3">
                <div class="flex justify-between items-end">
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Rest Duration</label>
                    <span id="disp-rest" class="font-mono-display text-2xl text-orange-400 font-bold">01:00</span>
                </div>
                <input type="range" min="10" max="300" step="10" value="60" id="in-rest">
            </div>
        </div>

        <!-- Coach Settings (Only for Freestyle) -->
        <div id="coach-settings" class="glass-card p-6 rounded-[2rem] space-y-5 border-t-2 border-purple-500/30 transition-all">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="font-bold text-white">Coach Callouts</h3>
                    <p class="text-xs text-slate-500">Audio commands</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="in-random" class="sr-only peer" checked>
                    <div class="w-12 h-6 bg-slate-800 rounded-full peer peer-checked:bg-purple-600 peer-checked:after:translate-x-6 after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all"></div>
                </label>
            </div>

            <div id="random-options" class="space-y-4">
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Intensity / Pace</label>
                        <span id="disp-pace" class="text-[10px] font-bold text-purple-400 uppercase">Medium</span>
                    </div>
                    <input type="range" min="1" max="3" value="2" id="in-pace">
                </div>
                
                <div class="grid grid-cols-2 gap-2" id="cat-select">
                    <label class="glass-inset p-3 rounded-xl flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" class="move-cat w-4 h-4 accent-purple-500" value="basics" checked>
                        <span class="text-xs font-bold text-slate-300">Basics</span>
                    </label>
                    <label class="glass-inset p-3 rounded-xl flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" class="move-cat w-4 h-4 accent-purple-500" value="defense" checked>
                        <span class="text-xs font-bold text-slate-300">Defense</span>
                    </label>
                    <label class="glass-inset p-3 rounded-xl flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" class="move-cat w-4 h-4 accent-purple-500" value="complex">
                        <span class="text-xs font-bold text-slate-300">Complex</span>
                    </label>
                    <label class="glass-inset p-3 rounded-xl flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" class="move-cat w-4 h-4 accent-purple-500" value="footwork">
                        <span class="text-xs font-bold text-slate-300">Footwork</span>
                    </label>
                </div>
            </div>
        </div>

        <button id="btn-start" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-5 rounded-2xl text-xl shadow-[0_0_20px_rgba(59,130,246,0.4)] active:scale-[0.98] transition-all">
            Begin Session
        </button>
    </div>

    <!-- TIMER SCREEN -->
    <div id="timer-screen" class="hidden w-full max-w-md flex-col items-center justify-between h-[90vh] py-8">
        
        <div class="w-full px-6 flex justify-between items-center">
            <div class="space-y-1">
                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em]" id="round-label">Round</p>
                <div class="flex items-baseline space-x-2">
                    <span id="current-round" class="text-4xl font-black font-mono-display text-white">1</span>
                    <span class="text-slate-600 text-xl font-bold">/</span>
                    <span id="total-rounds" class="text-slate-600 text-xl font-bold">12</span>
                </div>
            </div>
            <div id="phase-badge" class="px-4 py-2 rounded-full border text-[10px] font-black uppercase tracking-widest transition-colors duration-500">
                Ready
            </div>
        </div>

        <div class="relative w-80 h-80 flex items-center justify-center">
            <svg class="absolute inset-0 w-full h-full" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="46" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="4" />
                <circle id="progress-ring" class="timer-ring" cx="50" cy="50" r="46" fill="none" stroke="#3b82f6" stroke-width="4" stroke-linecap="round" stroke-dasharray="289" stroke-dashoffset="0" />
            </svg>
            
            <div class="text-center z-10">
                <div id="timer-display" class="text-7xl font-black font-mono-display text-white tracking-tighter">00:00</div>
                <div id="next-up" class="text-[10px] text-slate-500 mt-4 font-bold uppercase tracking-widest h-4"></div>
            </div>
        </div>

        <!-- Coach Callout Area -->
        <div id="callout-card" class="w-full glass-card h-32 rounded-[2rem] flex items-center justify-center px-8 transition-all duration-300 opacity-0 transform translate-y-4">
            <div class="text-center">
                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2" id="callout-label">Coach</p>
                <div id="current-callout" class="text-3xl font-black text-white uppercase tracking-tight leading-none">--</div>
            </div>
        </div>

        <div class="w-full px-4 grid grid-cols-2 gap-4">
            <button id="btn-pause" class="bg-slate-800 hover:bg-slate-700 text-white font-bold py-5 rounded-2xl transition-all active:scale-95">
                Pause
            </button>
            <button id="btn-end" class="bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/30 font-bold py-5 rounded-2xl transition-all active:scale-95">
                End
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Configuration Data
            const FREESTYLE_MOVES = {
                basics: ['Jab', 'Cross', '1-2', '1-1-2', 'Jab, Hook', 'Cross, Hook', 'Double Jab'],
                defense: ['Slip Left', 'Slip Right', 'Roll', 'Duck', 'High Block', 'Parry'],
                complex: ['1-2-3', '2-3-2', 'Lead Uppercut', 'Liver Shot', '1-2-Roll-2', 'Speed Jab'],
                footwork: ['Pivot', 'Step Back', 'Angle Right', 'Circle Left', 'Reset Center']
            };

            const PROGRAM_12_ROUNDS = [
                { name: "Warm Up: Slow Constant", moves: ['Jab', '1-2', 'Move', 'Breathe', 'Light 1-2', 'Shake out'] },
                { name: "3's", moves: ['1-2-3', 'Jab-Cross-Hook', 'Jab-Uppercut-Hook', 'Cross-Hook-Cross'] },
                { name: "Up & 1 x Hook", moves: ['Lead Uppercut-Hook', 'Rear Uppercut-Lead Hook', 'Uppercut-Hook', '5-3', '6-2'] },
                { name: "4's", moves: ['1-2-3-2', '1-2-5-2', 'Jab-Cross-Hook-Cross', '1-1-2-3'] },
                { name: "Power Singles", moves: ['Power Jab', 'Hard Cross', 'Big Hook', 'Overhand', 'Body Shot'] },
                { name: "Light 2's", moves: ['Fast 1-2', 'Touch-Touch', 'Jab-Cross (Fast)', 'High-Low'] },
                { name: "Double Jab + Power", moves: ['1-1-2', '1-1-Rear Hook', '1-1-Overhand', 'Jab-Jab-Cross'] },
                { name: "Light 3's", moves: ['Fast 1-2-3', 'Touch-Touch-Bang', 'Speed 3s'] },
                { name: "Hooks (Close)", moves: ['Lead Hook', 'Rear Hook', 'Body Hook', '3-4', 'Head-Body'] },
                { name: "Heavy 2's", moves: ['Hard 1-2', 'Power 1-2', 'Cross-Hook', 'Hook-Cross'] },
                { name: "Up & 2 Hooks", moves: ['Uppercut-Hook-Hook', '5-3-4', '6-3-2'] },
                { name: "Constant", moves: ['Non-stop', '1-2-1-2', 'Burnout', 'Speed', 'Go Go Go'] }
            ];

            // App State
            let settings = { 
                mode: 'freestyle', // or 'program'
                rounds: 12, 
                work: 180, 
                rest: 60, 
                partner: false,
                coach: true, 
                pace: 2, 
                cats: [] 
            };
            
            let session = { 
                active: false, 
                paused: false, 
                phase: 'ready', 
                round: 1, 
                time: 10, 
                total: 10, 
                timer: null, 
                callTimer: 0,
                lastMove: ''
            };
            
            let audioCtx = null;
            let wakeLock = null;

            // DOM Selectors
            const ui = {
                setup: document.getElementById('setup-screen'),
                timer: document.getElementById('timer-screen'),
                
                // Inputs
                inRounds: document.getElementById('in-rounds'),
                inWork: document.getElementById('in-work'),
                inRest: document.getElementById('in-rest'),
                inPartner: document.getElementById('in-partner'),
                inRandom: document.getElementById('in-random'),
                
                // Display
                dispRounds: document.getElementById('disp-rounds'),
                dispWork: document.getElementById('disp-work'),
                dispRest: document.getElementById('disp-rest'),
                dispPace: document.getElementById('disp-pace'),
                dispTime: document.getElementById('timer-display'),
                dispRoundCur: document.getElementById('current-round'),
                dispRoundTot: document.getElementById('total-rounds'),
                dispNext: document.getElementById('next-up'),
                dispCallout: document.getElementById('current-callout'),
                dispCallLabel: document.getElementById('callout-label'),
                
                // Mode Switchers
                modeFreestyle: document.getElementById('mode-freestyle'),
                modeProgram: document.getElementById('mode-program'),
                
                // Elements
                ring: document.getElementById('progress-ring'),
                badge: document.getElementById('phase-badge'),
                calloutCard: document.getElementById('callout-card'),
                coachSettings: document.getElementById('coach-settings'),
                roundLabel: document.getElementById('round-label'),
                groupRounds: document.getElementById('group-rounds'),
                
                // Buttons
                btnStart: document.getElementById('btn-start'),
                btnPause: document.getElementById('btn-pause'),
                btnEnd: document.getElementById('btn-end')
            };

            // Formatting
            const format = (s) => {
                const m = Math.floor(s / 60).toString().padStart(2, '0');
                const sec = (Math.max(0, s) % 60).toString().padStart(2, '0');
                return `${m}:${sec}`;
            };

            // Mode Switching Logic
            function setMode(mode) {
                settings.mode = mode;
                if (mode === 'freestyle') {
                    ui.modeFreestyle.className = "flex-1 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all bg-slate-700 text-white shadow-md";
                    ui.modeProgram.className = "flex-1 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all text-slate-400 hover:text-white";
                    
                    // Unlock Inputs
                    ui.groupRounds.classList.remove('opacity-50', 'pointer-events-none');
                    ui.coachSettings.classList.remove('hidden');
                } else {
                    ui.modeProgram.className = "flex-1 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all bg-blue-600 text-white shadow-md";
                    ui.modeFreestyle.className = "flex-1 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all text-slate-400 hover:text-white";
                    
                    // Preset Defaults for 12 Round Class
                    ui.inWork.value = 60; ui.dispWork.innerText = "01:00";
                    ui.inRest.value = 60; ui.dispRest.innerText = "01:00";
                    
                    // Lock Rounds (Visual feedback)
                    ui.inRounds.value = 12; ui.dispRounds.innerText = "12";
                    ui.groupRounds.classList.add('opacity-50', 'pointer-events-none');
                    
                    // Hide Freestyle Coach options
                    ui.coachSettings.classList.add('hidden');
                }
            }
            
            ui.modeFreestyle.onclick = () => setMode('freestyle');
            ui.modeProgram.onclick = () => setMode('program');

            // Input Updates
            ui.inRounds.oninput = (e) => ui.dispRounds.innerText = e.target.value;
            ui.inWork.oninput = (e) => ui.dispWork.innerText = format(e.target.value);
            ui.inRest.oninput = (e) => ui.dispRest.innerText = format(e.target.value);
            ui.inPartner.onchange = (e) => {
                if (e.target.checked && settings.mode === 'program') {
                     ui.dispRounds.innerText = "24";
                } else if (!e.target.checked && settings.mode === 'program') {
                     ui.dispRounds.innerText = "12";
                }
            };
            document.getElementById('in-pace').oninput = (e) => {
                const map = { 1: 'High Pace', 2: 'Medium', 3: 'Technical' };
                ui.dispPace.innerText = map[e.target.value];
            };
            ui.inRandom.onchange = (e) => {
                document.getElementById('random-options').style.opacity = e.target.checked ? '1' : '0.3';
            };

            // Audio
            function initAudio() {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') audioCtx.resume();
            }

            function playBell() {
                if (!audioCtx) return;
                const now = audioCtx.currentTime;
                [440, 880, 1200].forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = i === 0 ? 'sine' : 'triangle';
                    osc.frequency.setValueAtTime(freq, now);
                    gain.connect(audioCtx.destination);
                    osc.connect(gain);
                    gain.gain.setValueAtTime(0.5 / (i+1), now);
                    gain.gain.exponentialRampToValueAtTime(0.0001, now + (i === 0 ? 2 : 1));
                    osc.start(now);
                    osc.stop(now + 2);
                });
            }

            function playBeep(high = false) {
                if (!audioCtx) return;
                const now = audioCtx.currentTime;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(high ? 1000 : 600, now);
                gain.connect(audioCtx.destination);
                osc.connect(gain);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            }

            function speak(text) {
                if (!settings.coach) return;
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.rate = 1.2; u.pitch = 1; u.lang = 'en-GB';
                window.speechSynthesis.speak(u);
            }

            // Session Logic
            const setPhase = (phase) => {
                session.phase = phase;
                ui.calloutCard.classList.add('opacity-0', 'translate-y-4');
                
                if (phase === 'ready') {
                    session.time = 20; // 20s Prepare
                    session.total = 20;
                    ui.badge.innerText = "Prepare";
                    ui.badge.className = "px-4 py-2 rounded-full border border-blue-500/30 text-blue-400 text-[10px] font-black uppercase tracking-widest";
                    ui.ring.style.stroke = "#3b82f6";
                    ui.dispNext.innerText = "Gloves On - Get Ready";
                    if (settings.mode === 'program') {
                         ui.dispNext.innerText = "Next: Warm Up - Slow Constant";
                    }
                } else if (phase === 'work') {
                    session.time = settings.work; session.total = settings.work;
                    ui.badge.innerText = "Work";
                    ui.badge.className = "px-4 py-2 rounded-full border border-green-500/30 bg-green-500/10 text-green-400 text-[10px] font-black uppercase tracking-widest";
                    ui.ring.style.stroke = "#22c55e";
                    ui.dispRoundCur.innerText = session.round;
                    ui.dispNext.innerText = "";
                    playBell();
                    
                    // Show Program Info
                    ui.calloutCard.classList.remove('opacity-0', 'translate-y-4');
                    
                    if (settings.mode === 'program') {
                        // Calculate Theme Index (Handles Partner Mode where 1&2=Theme1, 3&4=Theme2)
                        const themeIndex = settings.partner 
                            ? Math.floor((session.round - 1) / 2) 
                            : session.round - 1;
                            
                        const theme = PROGRAM_12_ROUNDS[themeIndex % PROGRAM_12_ROUNDS.length];
                        
                        // Partner Mode Label
                        if (settings.partner) {
                             const pName = (session.round % 2 !== 0) ? "YOU" : "PARTNER";
                             ui.dispCallLabel.innerText = `${pName} â€¢ ${theme.name}`;
                        } else {
                             ui.dispCallLabel.innerText = theme.name;
                        }
                        
                        triggerCallout(true); // Initial callout for program
                    } else {
                        ui.dispCallLabel.innerText = "Freestyle";
                        if (settings.coach) triggerCallout(true);
                    }
                    
                } else if (phase === 'rest') {
                    session.time = settings.rest; session.total = settings.rest;
                    ui.badge.innerText = "Rest";
                    ui.badge.className = "px-4 py-2 rounded-full border border-orange-500/30 bg-orange-500/10 text-orange-400 text-[10px] font-black uppercase tracking-widest";
                    ui.ring.style.stroke = "#f97316";
                    
                    // Next Round Logic
                    if (session.round < settings.rounds) {
                        let nextText = `Up Next: Round ${session.round + 1}`;
                        
                        if (settings.mode === 'program') {
                            const nextIdx = settings.partner 
                                ? Math.floor(session.round / 2) // Logic holds: R1done(idx0.5->0) R2done(idx1->1)
                                : session.round;
                            
                            if (nextIdx < PROGRAM_12_ROUNDS.length) {
                                const nextTheme = PROGRAM_12_ROUNDS[nextIdx].name;
                                nextText += ` (${nextTheme})`;
                            }
                        }
                        ui.dispNext.innerText = nextText;
                    } else {
                        ui.dispNext.innerText = "Final Round Complete";
                    }
                    playBell();
                }
                updateUI();
            };

            function triggerCallout(first = false) {
                if (!settings.coach || session.phase !== 'work') return;
                
                let moveList = [];
                
                if (settings.mode === 'program') {
                    const themeIndex = settings.partner 
                        ? Math.floor((session.round - 1) / 2) 
                        : session.round - 1;
                    const theme = PROGRAM_12_ROUNDS[themeIndex % PROGRAM_12_ROUNDS.length];
                    moveList = theme.moves;
                    
                    // If first call of round, just announce theme if we haven't
                    if (first) {
                         speak(theme.name);
                         // Don't display name again as it's in the label
                         ui.dispCallout.innerText = "GO";
                    }
                } else {
                    // Freestyle Logic
                    if (settings.cats.length === 0) settings.cats = ['basics'];
                    const cat = settings.cats[Math.floor(Math.random() * settings.cats.length)];
                    moveList = FREESTYLE_MOVES[cat];
                }

                if (!first || settings.mode === 'freestyle') {
                    let move = moveList[Math.floor(Math.random() * moveList.length)];
                    // Prevent immediate repetition
                    if (move === session.lastMove && moveList.length > 1) {
                         move = moveList[(moveList.indexOf(move) + 1) % moveList.length];
                    }
                    session.lastMove = move;

                    ui.dispCallout.classList.add('scale-90', 'opacity-50');
                    setTimeout(() => {
                        ui.dispCallout.innerText = move;
                        ui.dispCallout.classList.remove('scale-90', 'opacity-50');
                        speak(move);
                    }, 100);
                }

                // Pace timing
                const delays = { 1: [2, 3], 2: [3, 5], 3: [5, 8] };
                const [min, max] = delays[settings.pace];
                session.callTimer = Math.floor(Math.random() * (max - min + 1) + min);
            }

            function updateUI() {
                ui.dispTime.innerText = format(session.time);
                const circumference = 289;
                const offset = circumference - ((session.time / session.total) * circumference);
                ui.ring.style.strokeDashoffset = offset;
            }

            function run() {
                session.timer = setInterval(() => {
                    if (session.paused) return;
                    session.time--;
                    
                    if (session.time <= 3 && session.time > 0) playBeep(session.time === 1);
                    
                    if (session.time < 0) {
                        if (session.phase === 'ready') setPhase('work');
                        else if (session.phase === 'work') {
                            if (session.round >= settings.rounds) end();
                            else setPhase('rest');
                        } else if (session.phase === 'rest') {
                            session.round++;
                            setPhase('work');
                        }
                    }

                    if (session.phase === 'work') {
                        session.callTimer--;
                        if (session.callTimer <= 0) triggerCallout();
                    }
                    updateUI();
                }, 1000);
            }

            function end() {
                session.active = false;
                clearInterval(session.timer);
                if (wakeLock) wakeLock.release();
                window.speechSynthesis.cancel();
                ui.timer.classList.add('hidden');
                ui.setup.classList.remove('hidden');
            }

            // Event Listeners
            ui.btnStart.onclick = async () => {
                initAudio();
                
                settings.partner = ui.inPartner.checked;
                settings.work = parseInt(ui.inWork.value);
                settings.rest = parseInt(ui.inRest.value);
                settings.pace = parseInt(document.getElementById('in-pace').value);
                settings.coach = ui.inRandom.checked;

                if (settings.mode === 'program') {
                    settings.rounds = settings.partner ? 24 : 12;
                } else {
                    settings.rounds = parseInt(ui.inRounds.value);
                    settings.cats = Array.from(document.querySelectorAll('.move-cat:checked')).map(c => c.value);
                }

                try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch(e){}

                ui.setup.classList.add('hidden');
                ui.timer.classList.remove('hidden');
                ui.timer.classList.add('flex');
                ui.dispRoundTot.innerText = settings.rounds;

                session.round = 1;
                session.active = true;
                setPhase('ready');
                run();
            };

            ui.btnEnd.onclick = end;

            ui.btnPause.onclick = () => {
                session.paused = !session.paused;
                ui.btnPause.innerText = session.paused ? "Resume" : "Pause";
                ui.btnPause.classList.toggle('bg-blue-600');
                ui.btnPause.classList.toggle('bg-slate-800');
            };
        });
    </script>
</body>
</html>

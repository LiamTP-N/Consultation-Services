<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Interval Coach | Dr. Pearson-Noseworthy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'DM Sans', system-ui, sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: contain; }
        .font-mono-display { font-family: 'Space Mono', monospace; }
        
        /* Glass styling consistent with your existing app */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(51, 65, 85, 0.5);
        }

        .timer-ring { transition: stroke-dashoffset 1s linear, stroke 0.3s; transform: rotate(-90deg); transform-origin: 50% 50%; }
        
        input[type="range"] {
            -webkit-appearance: none; width: 100%; height: 6px; background: #334155; border-radius: 3px; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #60A5FA; cursor: pointer; border: 2px solid #1e293b;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen flex flex-col items-center justify-center p-4">

    <div id="setup-screen" class="w-full max-w-md space-y-6 animate-fade-in">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-white tracking-tight mb-1">Interval Coach</h1>
            <p class="text-slate-400 text-sm">Dr. Pearson-Noseworthy</p>
        </div>

        <div class="glass-panel p-6 rounded-2xl space-y-6">
            
            <div class="space-y-2">
                <div class="flex justify-between">
                    <label class="text-sm font-bold text-slate-300 uppercase tracking-wider">Rounds</label>
                    <span id="disp-rounds" class="font-mono-display text-blue-400 font-bold">12</span>
                </div>
                <input type="range" min="1" max="20" value="12" id="in-rounds" oninput="updateDisp('rounds', this.value)">
            </div>

            <div class="space-y-2">
                <div class="flex justify-between">
                    <label class="text-sm font-bold text-slate-300 uppercase tracking-wider">Work</label>
                    <span id="disp-work" class="font-mono-display text-green-400 font-bold">03:00</span>
                </div>
                <input type="range" min="10" max="600" step="10" value="180" id="in-work" oninput="updateDisp('work', this.value)">
            </div>

            <div class="space-y-2">
                <div class="flex justify-between">
                    <label class="text-sm font-bold text-slate-300 uppercase tracking-wider">Rest</label>
                    <span id="disp-rest" class="font-mono-display text-orange-400 font-bold">01:00</span>
                </div>
                <input type="range" min="10" max="300" step="10" value="60" id="in-rest" oninput="updateDisp('rest', this.value)">
            </div>

        </div>

        <div class="glass-panel p-6 rounded-2xl space-y-6 border-t-4 border-t-purple-500">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="font-bold text-white">Coach Mode</h3>
                    <p class="text-xs text-slate-400">Random callouts during work</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="in-random" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                </label>
            </div>

            <div id="random-options" class="space-y-4 transition-all">
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <label class="text-xs font-bold text-slate-300 uppercase">Pace (Callouts)</label>
                        <span id="disp-pace" class="font-mono-display text-purple-300 text-xs">Medium</span>
                    </div>
                    <input type="range" min="1" max="3" value="2" id="in-pace" oninput="updatePace(this.value)">
                </div>
                
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <label class="flex items-center space-x-2 bg-slate-800 p-2 rounded cursor-pointer">
                        <input type="checkbox" class="move-cat accent-purple-500" value="basics" checked>
                        <span>Basics (1-2)</span>
                    </label>
                    <label class="flex items-center space-x-2 bg-slate-800 p-2 rounded cursor-pointer">
                        <input type="checkbox" class="move-cat accent-purple-500" value="defense" checked>
                        <span>Defense</span>
                    </label>
                    <label class="flex items-center space-x-2 bg-slate-800 p-2 rounded cursor-pointer">
                        <input type="checkbox" class="move-cat accent-purple-500" value="complex">
                        <span>Complex</span>
                    </label>
                    <label class="flex items-center space-x-2 bg-slate-800 p-2 rounded cursor-pointer">
                        <input type="checkbox" class="move-cat accent-purple-500" value="footwork">
                        <span>Footwork</span>
                    </label>
                </div>
            </div>
        </div>

        <button onclick="startTimer()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl text-lg shadow-lg active:scale-[0.98] transition-all">
            Start Workout
        </button>
    </div>

    <div id="timer-screen" class="hidden w-full max-w-md flex-col items-center justify-between h-[85vh]">
        
        <div class="w-full flex justify-between items-end border-b border-slate-700 pb-4">
            <div>
                <span class="text-xs text-slate-500 uppercase tracking-widest block">Round</span>
                <span class="text-3xl font-bold font-mono-display text-white">
                    <span id="current-round">1</span><span class="text-slate-600 text-lg">/</span><span id="total-rounds" class="text-slate-600 text-lg">12</span>
                </span>
            </div>
            <div class="text-right">
                <span id="phase-label" class="bg-green-500/20 text-green-400 px-3 py-1 rounded text-xs font-bold uppercase tracking-widest border border-green-500/30">Get Ready</span>
            </div>
        </div>

        <div class="relative w-72 h-72 flex items-center justify-center">
            <svg class="absolute inset-0 w-full h-full" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="45" fill="none" stroke="#1e293b" stroke-width="6" />
                <circle id="progress-ring" class="timer-ring" cx="50" cy="50" r="45" fill="none" stroke="#22c55e" stroke-width="6" stroke-linecap="round" stroke-dasharray="283" stroke-dashoffset="0" />
            </svg>
            
            <div class="text-center z-10">
                <div id="timer-display" class="text-6xl font-black font-mono-display text-white tracking-tighter">00:00</div>
                <div id="next-up" class="text-xs text-slate-400 mt-2 font-mono-display h-4"></div>
            </div>
        </div>

        <div id="move-container" class="w-full glass-panel h-32 rounded-2xl flex items-center justify-center p-4 transition-opacity duration-300 opacity-0">
            <div class="text-center">
                <div id="current-move" class="text-4xl font-black text-white uppercase leading-none">--</div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 w-full">
            <button onclick="togglePause()" id="btn-pause" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-4 rounded-xl transition-all">
                Pause
            </button>
            <button onclick="stopTimer()" class="bg-red-900/50 hover:bg-red-900/80 text-red-200 border border-red-900 font-bold py-4 rounded-xl transition-all">
                End
            </button>
        </div>
    </div>

    <script>
        // --- DATA ---
        const MOVES = {
            basics: ['Jab', 'Cross', '1-2', '1-1-2', 'Jab, Hook', 'Cross, Hook'],
            defense: ['Slip', 'Roll', 'Duck', 'Block', 'Slip-Jab', 'Roll-Cross'],
            complex: ['1-2-3', '2-3-2', 'Uppercut', 'Liver Shot', 'Hook-Cross-Hook', '6-3-2'],
            footwork: ['Pivot', 'Step Back', 'Angle', 'Circle Left', 'Circle Right']
        };

        // --- STATE ---
        let config = {
            rounds: 12,
            workSec: 180,
            restSec: 60,
            randomEnabled: true,
            pace: 2, // 1=Fast(2s), 2=Med(3.5s), 3=Slow(5s)
            categories: ['basics', 'defense']
        };

        let state = {
            active: false,
            paused: false,
            phase: 'ready', // ready, work, rest, finished
            round: 1,
            timeLeft: 10,
            totalTime: 10,
            interval: null,
            nextCallout: 0
        };

        let wakeLock = null;
        let audioCtx = null;

        // --- SETUP HANDLERS ---
        function updateDisp(type, val) {
            const el = document.getElementById(`disp-${type}`);
            if (type === 'rounds') {
                el.innerText = val;
            } else {
                const m = Math.floor(val / 60).toString().padStart(2, '0');
                const s = (val % 60).toString().padStart(2, '0');
                el.innerText = `${m}:${s}`;
            }
        }

        function updatePace(val) {
            const map = { 1: 'High (Active)', 2: 'Medium', 3: 'Low (Tech)' };
            document.getElementById('disp-pace').innerText = map[val];
        }

        document.getElementById('in-random').addEventListener('change', (e) => {
            const opts = document.getElementById('random-options');
            if(e.target.checked) {
                opts.classList.remove('opacity-50', 'pointer-events-none');
            } else {
                opts.classList.add('opacity-50', 'pointer-events-none');
            }
        });

        // --- AUDIO ENGINE (Web Audio API) ---
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playTone(freq, type, duration) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.value = freq;
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
            osc.stop(audioCtx.currentTime + duration);
        }

        function playBeep() { playTone(880, 'sine', 0.1); } // Second tick
        function playHighBeep() { playTone(1200, 'sine', 0.1); } // 3-2-1
        function playBell() { 
            // Simulated bell
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.value = 400; // Lower bell tone
            osc.type = 'triangle';
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            gain.gain.setValueAtTime(1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 1.5);
            osc.stop(audioCtx.currentTime + 1.5);
        }

        // --- SPEECH ENGINE ---
        function speak(text) {
            if (!config.randomEnabled) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.rate = 1.1;
            u.pitch = 1;
            u.lang = 'en-GB';
            window.speechSynthesis.speak(u);
        }

        // --- TIMER LOGIC ---
        async function startTimer() {
            initAudio();
            
            // Acquire wake lock
            try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch(err) {}

            // Gather config
            config.rounds = parseInt(document.getElementById('in-rounds').value);
            config.workSec = parseInt(document.getElementById('in-work').value);
            config.restSec = parseInt(document.getElementById('in-rest').value);
            config.randomEnabled = document.getElementById('in-random').checked;
            config.pace = parseInt(document.getElementById('in-pace').value);
            
            config.categories = [];
            document.querySelectorAll('.move-cat:checked').forEach(c => config.categories.push(c.value));
            if (config.categories.length === 0) config.categories = ['basics']; // Fallback

            // UI Switch
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('timer-screen').classList.remove('hidden');
            document.getElementById('timer-screen').classList.add('flex');
            
            document.getElementById('total-rounds').innerText = config.rounds;

            setPhase('ready');
            
            state.active = true;
            state.paused = false;
            state.round = 1;
            runLoop();
        }

        function stopTimer() {
            state.active = false;
            clearInterval(state.interval);
            if (wakeLock) wakeLock.release();
            window.speechSynthesis.cancel();
            
            document.getElementById('timer-screen').classList.add('hidden');
            document.getElementById('timer-screen').classList.remove('flex');
            document.getElementById('setup-screen').classList.remove('hidden');
        }

        function togglePause() {
            state.paused = !state.paused;
            document.getElementById('btn-pause').innerText = state.paused ? "Resume" : "Pause";
            document.getElementById('btn-pause').classList.toggle('bg-yellow-600');
            document.getElementById('btn-pause').classList.toggle('bg-slate-700');
        }

        function setPhase(phase) {
            state.phase = phase;
            const label = document.getElementById('phase-label');
            const ring = document.getElementById('progress-ring');
            const moveCont = document.getElementById('move-container');

            // Reset callout timer
            resetCalloutTimer();

            if (phase === 'ready') {
                state.timeLeft = 10;
                state.totalTime = 10;
                label.innerText = "GET READY";
                label.className = "bg-slate-700 text-white px-3 py-1 rounded text-xs font-bold uppercase tracking-widest border border-slate-500";
                ring.style.stroke = "#cbd5e1";
                moveCont.classList.add('opacity-0');
            } 
            else if (phase === 'work') {
                state.timeLeft = config.workSec;
                state.totalTime = config.workSec;
                label.innerText = "WORK";
                label.className = "bg-green-500/20 text-green-400 px-3 py-1 rounded text-xs font-bold uppercase tracking-widest border border-

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Daily Motion | Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>

    <style>
        body { font-size: 18px; }
        .high-vis-border { border: 4px solid #FCD34D; }
        .canvas-container { position: relative; width: 100%; max-width: 700px; margin: 0 auto; border-radius: 20px; overflow: hidden; }
        .output_canvas { width: 100%; height: 100%; display: block; object-fit: cover; }
        video { display: none; }
        #app-screen { display: none; }
        input[type=checkbox] { transform: scale(1.5); }
        
        .progress-bar-container { width: 100%; height: 20px; background-color: #374151; border-radius: 10px; margin-top: 10px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background-color: #3B82F6; width: 0%; transition: width 0.5s ease-in-out; }

        .stat-card { background-color: #1F2937; border: 2px solid #374151; border-radius: 1rem; padding: 1.5rem; text-align: center; }
        .stat-value { font-size: 2.5rem; font-weight: bold; color: white; }
        .stat-label { font-size: 0.9rem; color: #9CA3AF; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 0.5rem; }
        .stat-icon { font-size: 2rem; margin-bottom: 0.5rem; display: block; }
        .rom-card { border-color: #10B981; background-color: #064E3B; } 
    </style>
</head>
<body class="bg-slate-900 text-white font-sans min-h-screen flex flex-col">

    <nav class="bg-slate-800 py-6 text-center border-b border-slate-700">
        <h1 class="text-2xl md:text-3xl font-bold text-yellow-400">Dr. Pearson-Noseworthy's</h1>
        <p class="text-slate-300 text-lg mt-1 font-medium">Daily Mobility Check... you can do it!!</p>
    </nav>

    <section id="login-screen" class="flex-grow flex flex-col items-center justify-center p-4">
        <div class="bg-slate-800 p-8 rounded-2xl border-2 border-slate-600 w-full max-w-md shadow-2xl">
            <h2 class="text-3xl font-bold text-white mb-6 text-center">Member Login</h2>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-slate-400 text-sm font-bold mb-2 uppercase">Email Address</label>
                    <input type="email" id="email" autocomplete="username" class="w-full p-4 rounded-lg bg-slate-900 border border-slate-600 text-white text-xl focus:border-yellow-400 focus:outline-none" placeholder="name@email.com">
                </div>
                <div>
                    <label class="block text-slate-400 text-sm font-bold mb-2 uppercase">Password</label>
                    <input type="password" id="password" autocomplete="current-password" class="w-full p-4 rounded-lg bg-slate-900 border border-slate-600 text-white text-xl focus:border-yellow-400 focus:outline-none" placeholder="******">
                </div>
                
                <div class="flex items-center py-2">
                    <input id="rememberMe" type="checkbox" class="w-6 h-6 text-blue-600 bg-slate-900 border-slate-600 rounded focus:ring-blue-600" checked>
                    <label for="rememberMe" class="ml-4 text-lg text-slate-300 font-medium cursor-pointer">Keep me logged in</label>
                </div>

                <p id="loginError" class="text-red-400 font-bold text-center hidden">Incorrect Details</p>

                <button type="submit" id="loginBtn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold text-2xl py-4 rounded-xl shadow-lg transition-all">
                    LOG IN
                </button>
            </form>
        </div>
    </section>

    <section id="app-screen" class="flex-grow flex flex-col items-center justify-start pt-8 px-4 pb-8">
        
        <div class="bg-slate-800 p-6 rounded-2xl border-2 border-slate-600 text-center max-w-3xl w-full mb-6 shadow-xl">
            <div class="flex justify-between items-center mb-2">
                <span id="phaseLabel" class="text-blue-400 font-bold uppercase tracking-widest text-sm">Welcome</span>
                <span id="phaseStep" class="text-slate-400 text-sm">Step 0/3</span>
            </div>
            <h2 id="instructionTitle" class="text-3xl font-bold text-white mb-2">Welcome Back</h2>
            <p id="instructionText" class="text-xl text-yellow-200">Click the large green button to begin.</p>
            
            <div id="progressBar" class="progress-bar-container hidden">
                <div id="progressFill" class="progress-bar-fill"></div>
            </div>
        </div>

        <div class="grid lg:grid-cols-2 gap-8 w-full max-w-6xl items-start mb-8">
            <div class="col-span-1">
                <div class="canvas-container bg-black high-vis-border shadow-2xl aspect-video relative">
                    <video class="input_video"></video>
                    <canvas class="output_canvas"></canvas>
                    
                    <div class="hidden absolute top-4 left-4 bg-slate-900/90 p-4 rounded-xl border-2 border-white">
                        <p class="text-slate-300 text-sm uppercase font-bold tracking-widest">Knee Angle</p>
                        <p class="text-5xl font-bold text-white" id="angleDisplay">--</p>
                    </div>

                    <div id="pausedOverlay" class="absolute inset-0 bg-slate-900/95 flex flex-col items-center justify-center hidden z-20">
                        <p class="text-3xl font-bold text-yellow-400 mb-2">CAMERA PAUSED</p>
                        <p class="text-slate-300 text-lg">The camera is off.</p>
                    </div>

                    <div id="restOverlay" class="absolute inset-0 bg-slate-900/95 flex flex-col items-center justify-center hidden z-30">
                        <p class="text-2xl text-blue-300 mb-4">Rest & Recover</p>
                        <p id="timerDisplay" class="text-8xl font-bold text-white">30</p>
                        <p class="text-slate-400 mt-4 px-8 text-center">Take a deep breath. We will start the main test soon.</p>
                    </div>
                </div>

                <div class="mt-6 space-y-4">
                    <button id="startBtn" onclick="initCamera()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold text-3xl py-8 px-8 rounded-2xl shadow-xl border-b-8 border-green-800 active:border-b-0 active:translate-y-2 transition-all">
                        START CAMERA
                    </button>

                    <button id="toggleBtn" onclick="toggleCamera()" class="hidden w-full bg-red-600 hover:bg-red-500 text-white font-bold text-3xl py-6 px-8 rounded-2xl shadow-xl border-b-8 border-red-800 active:border-b-0 active:translate-y-2 transition-all">
                        STOP CAMERA
                    </button>
                </div>
            </div>

            <div class="col-span-1 bg-slate-800 rounded-2xl border-2 border-slate-600 p-6 h-full min-h-[400px]">
                <div class="flex justify-between items-center mb-6 border-b-2 border-slate-600 pb-4">
                    <h2 class="text-3xl font-bold text-white">Session Log</h2>
                    <span class="bg-blue-600 text-xl font-bold px-4 py-2 rounded-lg text-white">Live</span>
                </div>
                <div id="logContainer" class="space-y-4 max-h-[500px] overflow-y-auto pr-2">
                    <p class="text-slate-400 text-xl italic text-center mt-12">Follow the instructions on the left to begin.</p>
                </div>
            </div>
        </div>

        <div class="w-full max-w-6xl mt-8">
            <h3 class="text-2xl font-bold text-white mb-4 pl-2 border-l-4 border-green-500">&nbsp;Mobility & Health Tracker</h3>
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="stat-card rom-card">
                    <span class="stat-icon">üèÜ</span>
                    <div class="stat-value text-white" id="statRom">--</div>
                    <div class="stat-label text-green-200 font-bold">Best Score Ever</div>
                </div>
                <div class="stat-card rom-card bg-opacity-50">
                    <span class="stat-icon">üìä</span>
                    <div class="stat-value text-green-100" id="statAvg">--</div>
                    <div class="stat-label text-green-200">My Average Score</div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon">üî•</span>
                    <div class="stat-value" id="statReps">0</div>
                    <div class="stat-label">Total Squats</div>
                    <div class="text-xs text-slate-500 mt-1"><span id="statCals">0</span> kcals burned</div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon">üìÖ</span>
                    <div class="stat-value" id="statDays">0</div>
                    <div class="stat-label">Days Active</div>
                </div>
            </div>
            <p class="text-center text-slate-500 text-sm mt-6">Lower Score = Deeper Squat = Better Mobility!</p>
        </div>

    </section>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, setPersistence, browserLocalPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, setDoc, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBYpFeeBu8r1GYBjMzZEuf264pCEU6-6zU",
            authDomain: "rom-tracker-app.firebaseapp.com",
            projectId: "rom-tracker-app",
            storageBucket: "rom-tracker-app.firebasestorage.app",
            messagingSenderId: "133680237142",
            appId: "1:133680237142:web:1a846a2f3a240aca4a09f7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loginForm = document.getElementById('loginForm');
        const loginBtn = document.getElementById('loginBtn');
        const errorMsg = document.getElementById('loginError');
        const rememberMe = document.getElementById('rememberMe');

        // STATS
        const statReps = document.getElementById('statReps');
        const statCals = document.getElementById('statCals');
        const statRom = document.getElementById('statRom');
        const statAvg = document.getElementById('statAvg');
        const statDays = document.getElementById('statDays');

        let currentUserData = null;
        let currentUserId = null;

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUserId = user.uid;
                checkSubscription(user);
            }
        });

        async function checkSubscription(user) {
            try {
                const docRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists() && docSnap.data().paid === true) {
                    currentUserData = docSnap.data();
                    loadStatsToUI(currentUserData);
                    handleDailyLogin(docRef, currentUserData);

                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('app-screen').style.display = 'flex';
                } else {
                    throw new Error("Subscription inactive");
                }
            } catch (error) {
                auth.signOut();
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('app-screen').style.display = 'none';
                if(error.message.includes("Subscription")) {
                    errorMsg.innerText = "Subscription Inactive.";
                    errorMsg.classList.remove('hidden');
                }
            }
        }

        function loadStatsToUI(data) {
            statReps.innerText = data.totalReps || 0;
            statCals.innerText = data.totalCalories ? Math.round(data.totalCalories) : 0;
            statRom.innerText = data.bestRom ? data.bestRom + "¬∞" : "--";
            statDays.innerText = data.daysActive || 1;
            
            if (data.romHistory && data.romHistory.length > 0) {
                const sum = data.romHistory.reduce((a, b) => a + b, 0);
                const avg = Math.round(sum / data.romHistory.length);
                statAvg.innerText = avg + "¬∞";
            } else {
                statAvg.innerText = "--";
            }
        }

        async function handleDailyLogin(docRef, data) {
            const today = new Date().toDateString();
            if (data.lastLoginDate !== today) {
                const newDays = (data.daysActive || 0) + 1;
                await updateDoc(docRef, {
                    lastLoginDate: today,
                    daysActive: newDays
                });
                statDays.innerText = newDays;
            }
        }

        window.saveSessionToDatabase = async function(sessionReps, sessionBestDepth) {
            if (!currentUserId || !currentUserData) return;

            const docRef = doc(db, "users", currentUserId);
            
            const currentTotalReps = currentUserData.totalReps || 0;
            const currentCals = currentUserData.totalCalories || 0;
            const currentBestRom = currentUserData.bestRom || 180; 

            const newTotalReps = currentTotalReps + sessionReps;
            const newCals = currentCals + (sessionReps * 0.4); 
            
            let newBestRom = currentBestRom;
            if (sessionBestDepth < currentBestRom && sessionBestDepth > 40) {
                newBestRom = sessionBestDepth;
            }

            await updateDoc(docRef, {
                totalReps: newTotalReps,
                totalCalories: newCals,
                bestRom: newBestRom,
                lastActivity: serverTimestamp(),
                romHistory: arrayUnion(sessionBestDepth) 
            });

            statReps.innerText = newTotalReps;
            statCals.innerText = Math.round(newCals);
            statRom.innerText = newBestRom + "¬∞";
            
            if (currentUserData.romHistory) {
                const newHistory = [...currentUserData.romHistory, sessionBestDepth];
                const sum = newHistory.reduce((a, b) => a + b, 0);
                const avg = Math.round(sum / newHistory.length);
                statAvg.innerText = avg + "¬∞";
                currentUserData.romHistory = newHistory; 
            } else {
                statAvg.innerText = sessionBestDepth + "¬∞"; 
                currentUserData.romHistory = [sessionBestDepth];
            }
            
            currentUserData.totalReps = newTotalReps;
            currentUserData.totalCalories = newCals;
            currentUserData.bestRom = newBestRom;
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginBtn.innerText = "Checking...";
            errorMsg.classList.add('hidden');
            try {
                const mode = rememberMe.checked ? browserLocalPersistence : browserSessionPersistence;
                await setPersistence(auth, mode);
                const userCredential = await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
                await checkSubscription(userCredential.user);
            } catch (error) {
                loginBtn.innerText = "LOG IN";
                errorMsg.classList.remove('hidden');
                errorMsg.innerText = error.message.includes("Subscription") ? "Account Found, but Subscription is Inactive." : "Incorrect Email or Password.";
            }
        });
    </script>

    <script>
        let isSquatting = false;
        let currentSquatMin = 180;
        let firstFrameDetected = false;
        let cameraInstance = null;
        let isCameraRunning = false;
        let currentPhase = 0; 
        let warmupReps = 0;
        const TARGET_WARMUP_REPS = 5;

        const videoElement = document.getElementsByClassName('input_video')[0];
        const canvasElement = document.getElementsByClassName('output_canvas')[0];
        const canvasCtx = canvasElement.getContext('2d');
        const angleDisplay = document.getElementById('angleDisplay');
        const logContainer = document.getElementById('logContainer');
        const startBtn = document.getElementById('startBtn');
        const toggleBtn = document.getElementById('toggleBtn');
        const instrTitle = document.getElementById('instructionTitle');
        const instrText = document.getElementById('instructionText');
        const pausedOverlay = document.getElementById('pausedOverlay');
        const restOverlay = document.getElementById('restOverlay');
        const timerDisplay = document.getElementById('timerDisplay');
        const phaseLabel = document.getElementById('phaseLabel');
        const phaseStep = document.getElementById('phaseStep');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');

        // AUDIO PHRASES FOR SUPPORT
        const encouragements = [
            "Great start!", 
            "Looking strong!", 
            "Keep breathing!", 
            "Nice control!", 
            "Looking stable!"
        ];

        function speak(text) {
            window.speechSynthesis.cancel();
            let u = new SpeechSynthesisUtterance(text);
            u.rate = 0.9;
            window.speechSynthesis.speak(u);
        }

        function toggleCamera() {
            if (isCameraRunning) {
                cameraInstance.stop();
                isCameraRunning = false;
                toggleBtn.innerText = "RESUME CAMERA";
                toggleBtn.className = "w-full bg-green-600 hover:bg-green-500 text-white font-bold text-3xl py-6 px-8 rounded-2xl shadow-xl border-b-8 border-green-800 active:border-b-0 active:translate-y-2 transition-all";
                instrTitle.innerText = "Camera Paused";
                instrText.innerText = "The camera is off. Click Resume when you are ready.";
                pausedOverlay.classList.remove('hidden');
            } else {
                cameraInstance.start();
                isCameraRunning = true;
                toggleBtn.innerText = "STOP CAMERA";
                toggleBtn.className = "w-full bg-red-600 hover:bg-red-500 text-white font-bold text-3xl py-6 px-8 rounded-2xl shadow-xl border-b-8 border-red-800 active:border-b-0 active:translate-y-2 transition-all";
                instrTitle.innerText = "Warming Up...";
                instrText.innerText = "Starting camera again...";
                pausedOverlay.classList.add('hidden');
            }
        }

        function startRestTimer() {
            if (window.saveSessionToDatabase) {
                window.saveSessionToDatabase(5, 180); 
            }

            currentPhase = 2; // REST
            restOverlay.classList.remove('hidden');
            phaseLabel.innerText = "PHASE 2: RECOVER";
            phaseStep.innerText = "Step 2/3";
            instrTitle.innerText = "Resting...";
            instrText.innerText = "Please wait for the timer.";
            
            speak("Warm up complete. Please rest for 30 seconds.");

            let timeLeft = 30;
            const timer = setInterval(() => {
                timeLeft--;
                timerDisplay.innerText = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    restOverlay.classList.add('hidden');
                    startMainTest();
                }
            }, 1000);
        }

        function startMainTest() {
            currentPhase = 3; // MAIN TEST
            phaseLabel.innerText = "PHASE 3: ASSESSMENT";
            phaseStep.innerText = "Step 3/3";
            phaseLabel.classList.add("text-green-400");
            
            logContainer.innerHTML = "";
            const div = document.createElement("div");
            div.className = "text-center text-yellow-400 font-bold text-lg mb-4 border-b border-slate-600 pb-2";
            div.innerText = "--- OFFICIAL TEST ---";
            logContainer.appendChild(div);

            instrTitle.innerText = "Ready for Assessment";
            instrTitle.className = "text-3xl font-bold text-green-400 mb-2";
            instrText.innerText = "Turn sideways. Hold onto a chair if you need to. Squat as low as you safely can.";
            speak("Ready for assessment. Squat as low as you safely can.");
        }
        
        function initCamera() {
            instrTitle.innerText = "Warming Up...";
            instrText.innerText = "Please allow camera access on your device.";
            startBtn.style.display = 'none';
            toggleBtn.classList.remove('hidden');
            isCameraRunning = true;
            
            currentPhase = 1; 
            phaseLabel.innerText = "PHASE 1: WARM UP";
            phaseStep.innerText = "Step 1/3";
            progressBar.classList.remove('hidden');

            const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
            pose.setOptions({modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});

            pose.onResults((results) => {
                if (!firstFrameDetected) {
                    firstFrameDetected = true;
                    instrTitle.innerText = "Searching...";
                    instrText.innerText = "The camera sees the room. Now step into view.";
                }

                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
                canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

                if (results.poseLandmarks) {
                    drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#ffffff', lineWidth: 4});
                    drawLandmarks(canvasCtx, results.poseLandmarks, {color: '#FCD34D', lineWidth: 2, radius: 4});

                    const hip = results.poseLandmarks[24];
                    const knee = results.poseLandmarks[26];
                    const ankle = results.poseLandmarks[28];

                    if (hip && knee && ankle && hip.visibility > 0.5) {
                        let radians = Math.atan2(ankle.y - knee.y, ankle.x - knee.x) - Math.atan2(hip.y - knee.y, hip.x - knee.x);
                        let angle = Math.abs(radians * 180.0 / Math.PI);
                        if (angle > 180.0) angle = 360 - angle;
                        angle = Math.round(angle);
                        angleDisplay.innerText = angle + "¬∞";
                        
                        if (currentPhase === 2) return;
                        
                        if (!isSquatting) {
                            if (angle > 165) {
                                if (currentPhase === 1 && warmupReps === 0 && !isSquatting) {
                                    instrTitle.innerText = "Perfect Position";
                                    instrTitle.className = "text-3xl font-bold text-green-400 mb-2";
                                    instrText.innerText = "Turn sideways. Perform 5 gentle squats to warm up.";
                                } else if (currentPhase === 3 && !isSquatting) {
                                     instrTitle.innerText = "Assessment Mode";
                                     instrTitle.className = "text-3xl font-bold text-green-400 mb-2";
                                     instrText.innerText = "Perform your best squat when ready.";
                                }
                            } else {
                                if (!isSquatting) {
                                    instrTitle.innerText = "Please Stand Tall";
                                    instrTitle.className = "text-3xl font-bold text-yellow-400 mb-2";
                                    instrText.innerText = "The camera needs to see your legs straight to begin.";
                                }
                            }
                        } else if (angle < 130) {
                            isSquatting = true;
                            if (angle < currentSquatMin) currentSquatMin = angle;
                            
                            instrTitle.innerText = "Squatting...";
                            instrTitle.className = "text-3xl font-bold text-blue-400 mb-2";
                            
                            if (currentPhase === 1) instrText.innerText = "Gentle movement. Don't push too hard yet.";
                            if (currentPhase === 3) instrText.innerText = "Go as low as you safely can.";
                        }

                        if (isSquatting && angle > 165) {
                            if (currentPhase === 1) {
                                warmupReps++;
                                let percentage = (warmupReps / TARGET_WARMUP_REPS) * 100;
                                progressFill.style.width = percentage + "%";

                                if(warmupReps === 1) logContainer.innerHTML = "";
                                const entry = document.createElement("div");
                                entry.className = "flex justify-between items-center bg-slate-700 p-4 rounded-xl border-l-8 border-blue-400 mb-2 opacity-75";
                                entry.innerHTML = `<span class="text-white text-lg">Warmup ${warmupReps}/5</span><span class="text-white font-bold">${currentSquatMin}¬∞</span>`;
                                logContainer.prepend(entry);
                                
                                // Random Encouragement + Rep Count
                                let msg = encouragements[Math.floor(Math.random() * encouragements.length)];
                                speak(`${msg} Rep ${warmupReps}`);

                                if (warmupReps >= TARGET_WARMUP_REPS) {
                                    startRestTimer();
                                } else {
                                    instrTitle.innerText = `Rep ${warmupReps} Complete`;
                                    instrTitle.className = "text-3xl font-bold text-blue-400 mb-2";
                                    instrText.innerText = "Good. Stand tall, then go again.";
                                }
                            }
                            else if (currentPhase === 3) {
                                // SAVE TEST DATA TO DB
                                if (window.saveSessionToDatabase) {
                                    window.saveSessionToDatabase(1, currentSquatMin); 
                                }

                                const entry = document.createElement("div");
                                entry.className = "flex justify-between items-center bg-green-900 p-4 rounded-xl border-l-8 border-green-400 mb-2 shadow-lg scale-105";
                                entry.innerHTML = `<span class="font-bold text-white text-xl">TEST RESULT</span><span class="text-white font-bold text-3xl">${currentSquatMin}¬∞</span>`;
                                logContainer.prepend(entry);
                                
                                speak(`Assessment Complete. ${currentSquatMin} degrees.`);
                                
                                instrTitle.innerText = "Test Complete!";
                                instrTitle.className = "text-3xl font-bold text-green-400 mb-2";
                                instrText.innerText = "Excellent work. You can stop the camera now.";
                                currentPhase = 4;
                            }

                            isSquatting = false;
                            currentSquatMin = 180;
                        }
                    } else {
                        if(firstFrameDetected && !isSquatting && currentPhase !== 2) {
                            instrTitle.innerText = "Please Step Back";
                            instrTitle.className = "text-3xl font-bold text-red-400 mb-2";
                            instrText.innerText = "The camera needs to see your whole body, from head to toe.";
                        }
                    }
                }
            });

            // ZOOM FIX: Request 1280x720 to force Wide Angle on Mobile
            cameraInstance = new Camera(videoElement, {
                onFrame: async () => { await pose.send({image: videoElement}); },
                width: 1280,
                height: 720
            });
            cameraInstance.start();
        }
    </script>
</body>
</html>

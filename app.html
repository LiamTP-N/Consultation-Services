<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Functional Calibration | Dr. Pearson-Noseworthy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        html { scroll-behavior: smooth; }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(51, 65, 85, 0.5);
        }
        
        /* Animations */
        .animate-fade-in { animation: fadeIn 0.6s ease-out forwards; opacity: 0; }
        .animate-fade-in.loaded { opacity: 1; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Camera & Canvas - UPDATED FOR PORTRAIT */
        .canvas-wrapper { 
            position: relative; 
            width: 100%; 
            border-radius: 1rem; 
            overflow: hidden; 
            background-color: #0f172a; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); 
        }
        .output_canvas { width: 100%; height: 100%; object-fit: cover; display: block; }
        video { display: none; }

        /* Navigation */
        .view-section { display: none; opacity: 0; }
        .view-section.active { display: flex; animation: fadeIn 0.4s ease-out forwards; }
        
        .nav-tab { transition: all 0.2s ease; border-bottom: 4px solid transparent; opacity: 0.6; }
        .nav-tab.active { border-bottom: 4px solid #60A5FA; opacity: 1; background-color: rgba(30, 41, 59, 0.5); }

        /* Protocol Selector Buttons */
        .protocol-btn { border: 1px solid #475569; transition: all 0.3s; }
        .protocol-btn.selected { background-color: #2563EB; border-color: #3B82F6; color: white; box-shadow: 0 0 15px rgba(37, 99, 235, 0.5); }

        /* Depth Gauge */
        .depth-meter { height: 10px; width: 100%; background: #334155; border-radius: 5px; overflow: hidden; margin-top: 10px; }
        .depth-fill { height: 100%; width: 0%; background: #EF4444; transition: width 0.1s, background 0.3s; }

        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen flex flex-col">

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Scroll Effect
            const nav = document.querySelector('nav');
            const handleScroll = () => {
                if (window.scrollY > 50) {
                    nav.classList.remove('bg-transparent', 'py-4');
                    nav.classList.add('bg-slate-900/95', 'backdrop-blur-sm', 'shadow-md', 'py-3', 'border-b', 'border-slate-700');
                } else {
                    nav.classList.add('bg-transparent', 'py-4');
                    nav.classList.remove('bg-slate-900/95', 'backdrop-blur-sm', 'shadow-md', 'py-3', 'border-b', 'border-slate-700');
                }
            };
            window.addEventListener('scroll', handleScroll);
            handleScroll();

            // 2. Mobile Menu Toggle
            const btn = document.getElementById('mobile-menu-btn');
            const menu = document.getElementById('mobile-menu');

            if(btn && menu){
                btn.addEventListener('click', () => {
                    menu.classList.toggle('hidden');
                });
            }

            // 3. Animation Trigger
            document.querySelectorAll('.animate-fade-in').forEach((el, index) => {
                setTimeout(() => { el.classList.add('loaded'); }, 50 * (index + 1));
            });
        });
    </script>

    <nav class="fixed w-full z-50 transition-all duration-300 bg-transparent py-4">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex justify-between items-center">
                <a href="index.html" class="font-bold text-xl tracking-tight text-slate-100 hover:text-blue-400 transition">
                    Dr. Pearson-Noseworthy
                </a>
                </div>
        </div>
    </nav>

    <header id="app-nav" class="flex flex-col mt-20 bg-slate-950 border-b border-slate-800 relative z-40">
        <div class="flex justify-between items-center px-4 py-3 bg-slate-900/50">
            <div>
                <h1 class="text-lg font-bold text-white tracking-tight">Functional Calibration</h1>
                <p class="text-xs text-slate-400">Daily Protocol</p>
            </div>
            <button id="logoutBtn" class="hidden bg-red-600 hover:bg-red-500 text-white font-bold px-4 py-2 rounded-lg text-xs shadow-lg transition-all active:scale-95 border border-red-500 flex items-center gap-1">
                <span class="text-lg">√ó</span> EXIT APP
            </button>
        </div>

        <div class="grid grid-cols-5 w-full bg-slate-900 text-[10px] md:text-sm font-bold text-slate-300">
            <button onclick="switchView('warmup')" id="nav-warmup" class="nav-tab active py-3 flex flex-col items-center justify-center hover:bg-slate-800">
                <span class="text-orange-400 mb-0.5">STEP 1</span>
                <span>WARM UP</span>
            </button>
            <button onclick="switchView('assess')" id="nav-assess" class="nav-tab py-3 flex flex-col items-center justify-center hover:bg-slate-800">
                <span class="text-blue-400 mb-0.5">STEP 2</span>
                <span>BASELINE</span>
            </button>
            <button onclick="switchView('workout')" id="nav-workout" class="nav-tab py-3 flex flex-col items-center justify-center hover:bg-slate-800">
                <span class="text-green-400 mb-0.5">STEP 3</span>
                <span>TRAINING</span>
            </button>
            <button onclick="switchView('food')" id="nav-food" class="nav-tab py-3 flex flex-col items-center justify-center hover:bg-slate-800">
                <span class="text-yellow-400 mb-0.5">STEP 4</span>
                <span>FOOD</span>
            </button>
            <button onclick="switchView('home')" id="nav-home" class="nav-tab py-3 flex flex-col items-center justify-center hover:bg-slate-800">
                <span class="text-purple-400 mb-0.5">STEP 5</span>
                <span>PROGRESS</span>
            </button>
        </div>
    </header>

    <section id="auth-screen" class="hidden flex-grow flex flex-col items-center justify-center p-4 min-h-screen pt-32 pb-20">
        </section>

    <div id="app-container" class="block w-full max-w-4xl mx-auto p-4 pb-20">

        <section id="view-warmup" class="view-section active flex-col gap-6">
            <h2 class="text-2xl font-bold text-white">Step 1: Mobility Prep</h2>
            <p class="text-slate-400 text-sm -mt-4">Safety first. Prepare the joints.</p>
            
            <div class="glass-panel p-5 rounded-xl border border-slate-700">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-bold text-white">1. Marching in Place</h3>
                    <span class="bg-slate-800 text-slate-300 text-[10px] font-bold px-2 py-1 rounded">2 MINS</span>
                </div>
                <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50 text-xs text-slate-400 mb-2">
                    <strong class="text-orange-400 block mb-1">Evidence:</strong>
                    "Low-intensity aerobic activation is foundational." (Espejo-Ant√∫nez et al., 2020)
                </div>
                <button class="w-full bg-slate-700 hover:bg-orange-600 text-white py-2 rounded-lg text-sm font-bold transition-colors">Mark Complete</button>
            </div>

            <div class="glass-panel p-5 rounded-xl border border-slate-700">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-bold text-white">2. Heel & Toe Raises</h3>
                    <span class="bg-slate-800 text-slate-300 text-[10px] font-bold px-2 py-1 rounded">15 REPS</span>
                </div>
                <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50 text-xs text-slate-400 mb-2">
                    <strong class="text-orange-400 block mb-1">Evidence:</strong>
                    "Ankle dorsiflexor activation is critical for gait stability." (Review Consensus)
                </div>
                <button class="w-full bg-slate-700 hover:bg-orange-600 text-white py-2 rounded-lg text-sm font-bold transition-colors">Mark Complete</button>
            </div>

            <button onclick="switchView('assess')" class="w-full bg-slate-800 hover:bg-blue-600 text-white py-4 rounded-xl font-bold transition-all shadow-lg flex items-center justify-center gap-2 mt-4">
                Next: Establish Baseline <span class="text-xl">‚Üí</span>
            </button>
        </section>

        <section id="view-assess" class="view-section flex-col items-center">
            
            <div class="glass-panel p-4 rounded-xl w-full mb-6 text-center border-l-4 border-l-blue-500">
                <h2 class="text-xl font-bold text-white mb-1">Step 2: Baseline Assessment</h2>
                <p class="text-slate-400 text-sm">Perform your deepest comfortable squat.</p>
            </div>

            <div class="canvas-wrapper mb-4 relative aspect-[9/16] w-full max-w-sm mx-auto border border-slate-700">
                <video class="input_video"></video>
                <canvas class="output_canvas"></canvas>
                
                <div class="absolute top-4 left-4 bg-black/60 backdrop-blur px-3 py-1 rounded-full border border-white/10">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse hidden" id="assess-dot"></div>
                        <span class="text-xs font-mono text-white/80">LIVE FEED</span>
                    </div>
                </div>

                <div class="absolute bottom-4 left-0 right-0 text-center">
                    <span class="bg-black/50 text-xs text-slate-300 px-3 py-1 rounded-full backdrop-blur-sm">Side View | Waist-Down Only</span>
                </div>

                <div class="absolute inset-0 flex items-center justify-center z-20" id="assessOverlay">
                    <button onclick="initCamera('assess')" class="bg-blue-600 hover:bg-blue-500 text-white font-bold px-8 py-3 rounded-full shadow-lg transition-all">
                        Start Assessment
                    </button>
                </div>
                
                <div id="assess-status" class="hidden absolute top-1/2 left-0 right-0 text-center -translate-y-1/2">
                    <div class="bg-black/70 backdrop-blur mx-auto inline-block px-6 py-4 rounded-xl border border-white/20">
                        <p class="text-lg font-bold text-white mb-1">Looking for subject...</p>
                        <p class="text-xs text-slate-300">Please stand sideways in frame.</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 w-full max-w-lg mb-2">
                <div class="glass-panel p-3 rounded-xl text-center border border-slate-700/50">
                    <p class="text-[10px] text-slate-500 uppercase tracking-widest mb-1">Knee Flexion</p>
                    <div class="text-3xl font-bold text-white" id="assess-knee">--¬∞</div>
                </div>
                <div class="glass-panel p-3 rounded-xl text-center border border-slate-700/50">
                    <p class="text-[10px] text-slate-500 uppercase tracking-widest mb-1">Hip Flexion</p>
                    <div class="text-3xl font-bold text-blue-400" id="assess-hip">--¬∞</div>
                </div>
            </div>

            <div class="w-full max-w-lg">
                <button onclick="saveAssessment()" id="saveAssessBtn" class="hidden w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg shadow-lg">
                    SAVE KNEE BASELINE
                </button>
            </div>
            
            <div class="mt-4">
                 <button onclick="switchView('workout')" class="text-slate-400 hover:text-white flex items-center gap-2 transition-colors">
                     Next: Training <span class="text-xl">‚Üí</span>
                 </button>
            </div>
        </section>

        <section id="view-workout" class="view-section flex-col items-center">
            
            <div class="w-full mb-4">
                <h2 class="text-xl font-bold text-white mb-2">Step 3: Smart Training</h2>
                
                <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 flex justify-between items-center mb-4">
                    <div>
                        <p class="text-[10px] text-slate-500 uppercase tracking-widest">Target Knee Depth</p>
                        <p class="text-2xl font-bold text-green-400" id="daily-target-display">--¬∞</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] text-slate-500 uppercase tracking-widest">Strictness</p>
                        <p class="text-lg font-bold text-white" id="strictness-display">50%</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button onclick="setProtocol('power')" id="btn-power" class="protocol-btn selected p-3 rounded-xl flex flex-col items-center justify-center bg-slate-800/50">
                        <svg class="w-6 h-6 mb-1 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        <span class="font-bold text-sm">MAX POWER</span>
                        <span class="text-[10px] text-slate-400">Fast Up</span>
                    </button>
                    <button onclick="setProtocol('capacity')" id="btn-capacity" class="protocol-btn p-3 rounded-xl flex flex-col items-center justify-center bg-slate-800/50">
                        <svg class="w-6 h-6 mb-1 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span class="font-bold text-sm">CAPACITY</span>
                        <span class="text-[10px] text-slate-400">30s Test</span>
                    </button>
                </div>
            </div>

            <div class="canvas-wrapper mb-4 relative aspect-[9/16] w-full max-w-sm mx-auto border border-slate-700">
                <video class="input_video_train" style="display:none"></video>
                <canvas class="output_canvas_train"></canvas>
                
                <div class="absolute inset-0 flex items-center justify-center z-20" id="trainOverlay">
                    <button onclick="initCamera('train')" class="bg-green-600 hover:bg-green-500 text-white font-bold px-8 py-3 rounded-full shadow-lg transition-all">
                        Start Session
                    </button>
                </div>

                 <div id="train-status" class="hidden absolute top-1/2 left-0 right-0 text-center -translate-y-1/2">
                    <div class="bg-black/70 backdrop-blur mx-auto inline-block px-6 py-4 rounded-xl border border-white/20">
                        <p class="text-lg font-bold text-white mb-1">Looking for subject...</p>
                        <p class="text-xs text-slate-300">Please stand sideways in frame.</p>
                    </div>
                </div>
                
                <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/90 to-transparent">
                    <div class="flex justify-between text-xs font-bold text-white mb-1">
                        <span>KNEE DEPTH</span>
                        <span id="rep-feedback">WAITING</span>
                    </div>
                    <div class="depth-meter">
                        <div class="depth-fill" id="depth-bar"></div>
                    </div>
                    <div class="text-[10px] text-slate-400 text-right mt-1">Hip: <span id="train-hip-val">--</span>¬∞</div>
                </div>
            </div>

            <div class="w-full max-w-lg glass-panel rounded-xl p-4 flex justify-between items-center">
                <div>
                    <span class="text-xs text-slate-500 uppercase">Reps</span>
                    <div class="text-3xl font-bold text-white" id="train-reps">0</div>
                </div>
                <button onclick="finishSession()" id="finishBtn" class="bg-slate-700 hover:bg-slate-600 text-white px-6 py-2 rounded-lg font-bold text-sm">
                    FINISH
                </button>
            </div>
            
            <div class="mt-4">
                 <button onclick="switchView('food')" class="text-slate-400 hover:text-white flex items-center gap-2 transition-colors">
                     Next: Log Nutrition <span class="text-xl">‚Üí</span>
                 </button>
            </div>
        </section>

        <section id="view-food" class="view-section flex-col gap-6">
            <h2 class="text-2xl font-bold text-white">Step 4: Protein Check</h2>
            <p class="text-slate-400 text-sm -mt-4">Anabolic resistance requires higher protein intake (25-30g/meal).</p>

            <div class="glass-panel p-6 rounded-xl space-y-4">
                <label class="flex items-center space-x-3 p-3 bg-slate-900/50 rounded-lg border border-slate-700/50 cursor-pointer">
                    <input type="checkbox" class="w-5 h-5 text-green-500 rounded bg-slate-700 border-slate-600" onchange="saveFood()">
                    <span class="text-slate-200">Breakfast Protein</span>
                </label>
                <label class="flex items-center space-x-3 p-3 bg-slate-900/50 rounded-lg border border-slate-700/50 cursor-pointer">
                    <input type="checkbox" class="w-5 h-5 text-green-500 rounded bg-slate-700 border-slate-600" onchange="saveFood()">
                    <span class="text-slate-200">Lunch Protein</span>
                </label>
                <label class="flex items-center space-x-3 p-3 bg-slate-900/50 rounded-lg border border-slate-700/50 cursor-pointer">
                    <input type="checkbox" class="w-5 h-5 text-green-500 rounded bg-slate-700 border-slate-600" onchange="saveFood()">
                    <span class="text-slate-200">Dinner Protein</span>
                </label>
            </div>
            
            <div class="mt-4 text-center">
                 <button onclick="switchView('home')" class="text-slate-400 hover:text-white inline-flex items-center gap-2 transition-colors">
                     Finish: View Stats <span class="text-xl">‚Üí</span>
                 </button>
            </div>
        </section>

        <section id="view-home" class="view-section flex-col gap-6">
            <div class="bg-gradient-to-br from-blue-900/40 to-slate-900/40 border border-blue-500/30 p-6 rounded-2xl">
                <h3 class="text-blue-400 font-bold uppercase tracking-widest text-xs mb-2">Smart Progression</h3>
                <p class="text-slate-300 text-sm">Your target depth becomes 1% stricter every session. You are currently training at <span id="stat-strictness" class="text-white font-bold">50%</span> of your assessed range.</p>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="glass-panel p-5 rounded-2xl text-center border-t-2 border-green-500">
                    <div class="text-2xl mb-1 text-slate-400">‚ö°</div>
                    <div class="text-2xl font-bold text-white" id="statReps">0</div>
                    <div class="text-[10px] font-bold text-slate-500 uppercase">Total Reps</div>
                </div>
                <div class="glass-panel p-5 rounded-2xl text-center border-t-2 border-blue-500">
                    <div class="text-2xl mb-1 text-slate-400">üìè</div>
                    <div class="text-2xl font-bold text-white" id="statBaseline">--</div>
                    <div class="text-[10px] font-bold text-slate-500 uppercase">Baseline Depth</div>
                </div>
            </div>
        </section>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG DISABLED FOR NOW
        const firebaseConfig = {
            apiKey: "AIzaSyBYpFeeBu8r1GYBjMzZEuf264pCEU6-6zU",
            authDomain: "rom-tracker-app.firebaseapp.com",
            projectId: "rom-tracker-app",
            storageBucket: "rom-tracker-app.firebasestorage.app",
            messagingSenderId: "133680237142",
            appId: "1:133680237142:web:1a846a2f3a240aca4a09f7"
        };

        const app = initializeApp(firebaseConfig);
        // const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserId = "guest_user";
        window.userData = null; 
        
        // --- BYPASS LOGIN: Auto Enter ---
        // onAuthStateChanged(auth, async (user) => { ... }); // DISABLED
        
        // Mock Initialize
        setTimeout(() => {
            window.userData = { 
                email: "guest@example.com", 
                totalReps: 0, 
                baselineRom: 0, 
                sessionsCompleted: 0 
            };
            enterApp();
        }, 500);

        function enterApp() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            document.getElementById('app-nav').style.display = 'flex';
            loadStats();
            switchView('warmup');
        }

        function loadStats() {
            if(!window.userData) return;
            document.getElementById('statReps').innerText = window.userData.totalReps || 0;
            document.getElementById('statBaseline').innerText = window.userData.baselineRom ? window.userData.baselineRom + "¬∞" : "Not Set";
            
            const strictness = Math.min(100, 50 + ((window.userData.sessionsCompleted || 0) * 1));
            document.getElementById('stat-strictness').innerText = strictness + "%";
        }

        window.updateBaseline = async (rom) => {
            window.userData.baselineRom = rom;
            loadStats();
        };

        window.logSessionComplete = async (reps) => {
            window.userData.totalReps += reps;
            window.userData.sessionsCompleted += 1;
            loadStats();
        };
    </script>

    <script>
        let currentProtocol = 'power';
        let currentMode = 'none'; // 'assess' or 'train'
        let assessBestKnee = 180;
        let trainRepCount = 0;
        let isSquatting = false;
        let dailyTarget = 180;
        
        // New Flag for Smart Start
        let isSubjectDetected = false; 

        window.switchView = (view) => {
            if (view === 'workout' && (!window.userData || !window.userData.baselineRom)) {
                // Bypass for now for testing
                // alert("Please complete Step 2: Baseline Assessment first.");
                // switchView('assess');
                // return;
            }

            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${view}`).classList.add('active');
            document.getElementById(`nav-${view}`).classList.add('active');
            
            stopCameraLogic();
            
            if (view === 'workout') {
                calculateSmartTarget();
            }
        }

        function calculateSmartTarget() {
            const baseline = window.userData.baselineRom || 90; // Default if not set
            const sessions = window.userData.sessionsCompleted || 0;
            
            const standing = 170;
            const range = standing - baseline;
            const strictnessPercent = Math.min(100, 50 + sessions) / 100;
            const buffer = range * (1 - strictnessPercent);
            
            dailyTarget = Math.round(baseline + buffer);
            
            document.getElementById('daily-target-display').innerText = dailyTarget + "¬∞";
            document.getElementById('strictness-display').innerText = Math.round(strictnessPercent * 100) + "%";
        }

        window.setProtocol = (type) => {
            currentProtocol = type;
            document.getElementById('btn-power').classList.toggle('selected', type === 'power');
            document.getElementById('btn-capacity').classList.toggle('selected', type === 'capacity');
            document.getElementById('btn-power').classList.toggle('bg-slate-800/50', type !== 'power');
            document.getElementById('btn-capacity').classList.toggle('bg-slate-800/50', type !== 'capacity');
        }

        // Camera Logic
        let cameraInstance = null;
        const videoElement = document.getElementsByClassName('input_video')[0];
        const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
        pose.setOptions({modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
        pose.onResults(onResults);

        window.initCamera = (mode) => {
            currentMode = mode;
            isSubjectDetected = false; // Reset detection
            let videoEl;
            
            if (mode === 'assess') {
                videoEl = document.querySelector('#view-assess video');
                document.getElementById('assessOverlay').style.display = 'none';
                document.getElementById('assess-status').classList.remove('hidden'); // Show "Looking for subject"
            } else {
                videoEl = document.querySelector('#view-workout video');
                document.querySelector('#view-workout .input_video_train').style.display = 'block'; 
                document.getElementById('trainOverlay').style.display = 'none';
                document.getElementById('train-status').classList.remove('hidden'); // Show "Looking for subject"
            }

            cameraInstance = new Camera(videoEl, {
                onFrame: async () => { await pose.send({image: videoEl}); },
                // CHANGED TO PORTRAIT
                width: 720, height: 1280
            });
            cameraInstance.start();
        }

        window.stopCameraLogic = () => {
            if(cameraInstance) cameraInstance.stop();
            document.getElementById('assessOverlay').style.display = 'flex';
            document.getElementById('trainOverlay').style.display = 'flex';
            document.getElementById('assess-status').classList.add('hidden');
            document.getElementById('train-status').classList.add('hidden');
            document.getElementById('assess-dot').classList.add('hidden');
            currentMode = 'none';
            isSubjectDetected = false;
        }

        window.saveAssessment = () => {
            if(assessBestKnee < 170) {
                window.updateBaseline(assessBestKnee);
                alert("Baseline Saved: " + assessBestKnee + " degrees");
                stopCameraLogic();
                switchView('workout');
            }
        };

        window.finishSession = () => {
            window.logSessionComplete(trainRepCount);
            alert("Great job! Session logged.");
            stopCameraLogic();
            switchView('home');
        };

        function calculateAngle(a, b, c) {
            let radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs(radians * 180.0 / Math.PI);
            if (angle > 180.0) angle = 360 - angle;
            return Math.round(angle);
        }

        function onResults(results) {
            let canvasCtx, canvasEl, statusEl;
            
            if (currentMode === 'assess') {
                canvasEl = document.querySelector('#view-assess canvas');
                statusEl = document.getElementById('assess-status');
            } else if (currentMode === 'train') {
                canvasEl = document.querySelector('#view-workout canvas');
                statusEl = document.getElementById('train-status');
            } else {
                return;
            }
            
            canvasCtx = canvasEl.getContext('2d');
            // Force Portrait Dimensions for Canvas
            canvasEl.width = 720;
            canvasEl.height = 1280;

            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasEl.width, canvasEl.height);
            
            // Draw Video
            canvasCtx.drawImage(results.image, 0, 0, canvasEl.width, canvasEl.height);

            if (results.poseLandmarks) {
                // Landmarks: 24 (R.Hip), 26 (R.Knee), 28 (R.Ankle)
                const hip = results.poseLandmarks[24];
                const knee = results.poseLandmarks[26];
                const ankle = results.poseLandmarks[28];
                const shoulder = results.poseLandmarks[12];

                // --- SMART START LOGIC ---
                // We check if Hip, Knee, Ankle are HIGHLY visible (> 0.8)
                const isVisible = (hip && hip.visibility > 0.8 && knee && knee.visibility > 0.8 && ankle && ankle.visibility > 0.8);
                
                // If not yet detected/active, just check for presence
                if (!isSubjectDetected) {
                    if (isVisible) {
                        isSubjectDetected = true;
                        statusEl.classList.add('hidden'); // Hide "Looking for..." text
                        if(currentMode === 'assess') document.getElementById('assess-dot').classList.remove('hidden');
                    } else {
                        // Not found yet? Don't draw overlays, just return (or keep showing video)
                        canvasCtx.restore();
                        return;
                    }
                }

                // If we are here, isSubjectDetected is TRUE. Start Overlays & Math.

                // --- OVERLAY: Draw Skeleton ---
                canvasCtx.lineWidth = 4;
                canvasCtx.strokeStyle = 'white';
                canvasCtx.lineCap = 'round';
                
                const drawLine = (p1, p2) => {
                    canvasCtx.beginPath();
                    canvasCtx.moveTo(p1.x * canvasEl.width, p1.y * canvasEl.height);
                    canvasCtx.lineTo(p2.x * canvasEl.width, p2.y * canvasEl.height);
                    canvasCtx.stroke();
                };
                
                // Draw white lines
                drawLine(shoulder, hip);
                drawLine(hip, knee);
                drawLine(knee, ankle);

                // --- OVERLAY: Draw Joint Markers (Circles) ---
                const drawJoint = (p) => {
                    canvasCtx.beginPath();
                    canvasCtx.arc(p.x * canvasEl.width, p.y * canvasEl.height, 8, 0, 2 * Math.PI);
                    canvasCtx.fillStyle = '#3B82F6'; // Blue
                    canvasCtx.fill();
                    canvasCtx.lineWidth = 2;
                    canvasCtx.strokeStyle = 'white';
                    canvasCtx.stroke();
                };

                drawJoint(shoulder);
                drawJoint(hip);
                drawJoint(knee);
                drawJoint(ankle);

                // --- ANGLES ---
                let kneeAngle = calculateAngle(hip, knee, ankle);
                let hipAngle = calculateAngle(shoulder, hip, knee);

                // ASSESS MODE
                if (currentMode === 'assess') {
                    document.getElementById('assess-knee').innerText = kneeAngle + "¬∞";
                    document.getElementById('assess-hip').innerText = hipAngle + "¬∞";

                    if (kneeAngle < assessBestKnee && kneeAngle > 40) {
                        assessBestKnee = kneeAngle;
                        document.getElementById('saveAssessBtn').classList.remove('hidden');
                    }
                }

                // TRAIN MODE
                if (currentMode === 'train') {
                    document.getElementById('train-hip-val').innerText = hipAngle;
                    
                    let percentage = 0;
                    if (kneeAngle < 170) {
                        const totalDist = 170 - dailyTarget;
                        const currentDist = 170 - kneeAngle;
                        percentage = Math.min(100, Math.max(0, (currentDist / totalDist) * 100));
                    }
                    
                    const bar = document.getElementById('depth-bar');
                    const label = document.getElementById('rep-feedback');
                    bar.style.width = percentage + "%";
                    
                    if (kneeAngle <= dailyTarget) {
                        bar.style.backgroundColor = "#22c55e"; // Green
                        label.innerText = "GOOD DEPTH";
                        label.className = "text-green-400 font-bold";
                    } else {
                        bar.style.backgroundColor = "#EF4444"; // Red
                        label.innerText = "GO DEEPER";
                        label.className = "text-red-400 font-bold";
                    }

                    if (!isSquatting && kneeAngle <= dailyTarget) {
                        isSquatting = true;
                    } else if (isSquatting && kneeAngle > 165) {
                        trainRepCount++;
                        document.getElementById('train-reps').innerText = trainRepCount;
                        isSquatting = false;
                        
                        window.speechSynthesis.cancel();
                        let u = new SpeechSynthesisUtterance(trainRepCount.toString());
                        window.speechSynthesis.speak(u);
                    }
                }
            }
            canvasCtx.restore();
        }
    </script>
</body>
</html>

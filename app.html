<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member Portal | Dr. Pearson-Noseworthy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>

    <style>
        /* Custom Animations & Base Styles */
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(51, 65, 85, 0.5);
        }
        
        /* Animation Classes */
        .animate-fade-in { 
            animation: fadeIn 0.5s ease-out forwards; 
            opacity: 0; 
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Camera & Canvas */
        .canvas-wrapper { position: relative; width: 100%; border-radius: 1rem; overflow: hidden; background-color: #0f172a; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .output_canvas { width: 100%; height: auto; display: block; }
        video { display: none; }

        /* Navigation Transitions */
        .view-section { 
            display: none; 
            opacity: 0; 
        }
        
        .view-section.active { 
            display: flex; 
            animation: fadeIn 0.4s ease-out forwards; 
        }
        
        /* Tab Styling */
        .nav-tab { transition: all 0.2s ease; border-bottom: 4px solid transparent; opacity: 0.6; }
        .nav-tab.active { border-bottom: 4px solid #60A5FA; opacity: 1; background-color: rgba(30, 41, 59, 0.5); }

        /* Scrollbar for log */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 min-h-screen flex flex-col">

    <header id="app-nav" class="hidden flex-col sticky top-0 z-50 bg-slate-950 shadow-xl border-b border-slate-800">
        <div class="flex justify-between items-center p-4">
            <div>
                <h1 class="text-lg font-bold text-white tracking-tight">Health Portal</h1>
                <p class="text-xs text-slate-400">Dr. Pearson-Noseworthy</p>
            </div>
            <button id="logoutBtn" class="bg-red-600 hover:bg-red-500 text-white font-bold px-6 py-2 rounded-lg shadow-lg shadow-red-900/20 transition-all active:scale-95 border border-red-500">
                LOG OUT
            </button>
        </div>

        <div class="grid grid-cols-5 w-full bg-slate-900 text-[10px] md:text-sm font-bold text-slate-300">
            <button onclick="switchView('warmup')" id="nav-warmup" class="nav-tab active py-3 flex flex-col items-center justify-center hover:bg-slate-800">
                <span class="text-orange-400 mb-0.5">STEP 1</span>
                <span>WARM UP</span>
            </button>
            <button onclick="switchView('assess')" id="nav-assess" class="nav-tab py-3 flex flex-col items-center justify-center hover:bg-slate-800">
                <span class="text-blue-400 mb-0.5">STEP 2</span>
                <span>TEST</span>
            </button>
            <button onclick="switchView('workout')" id="nav-workout" class="nav-tab py-3 flex flex-col items-center justify-center hover:bg-slate-800">
                <span class="text-green-400 mb-0.5">STEP 3</span>
                <span>EXERCISE</span>
            </button>
            <button onclick="switchView('food')" id="nav-food" class="nav-tab py-3 flex flex-col items-center justify-center hover:bg-slate-800">
                <span class="text-yellow-400 mb-0.5">STEP 4</span>
                <span>FOOD</span>
            </button>
            <button onclick="switchView('home')" id="nav-home" class="nav-tab py-3 flex flex-col items-center justify-center hover:bg-slate-800">
                <span class="text-purple-400 mb-0.5">STEP 5</span>
                <span>STATS</span>
            </button>
        </div>
    </header>

    <section id="auth-screen" class="flex-grow flex flex-col items-center justify-center p-4 min-h-screen">
        <div class="w-full max-w-md animate-fade-in" style="animation-delay: 0.1s;">
            <div class="text-center mb-8">
                <h1 class="text-2xl md:text-3xl font-bold text-white mb-2">Dr. Pearson-Noseworthy</h1>
                <p class="text-slate-400 text-sm">Clinical Performance & Research Portal</p>
            </div>

            <div class="glass-panel rounded-2xl p-8 shadow-2xl">
                <div class="flex bg-slate-900/50 p-1 rounded-lg mb-8 border border-slate-700/50">
                    <button onclick="toggleAuthMode('login')" id="tab-login" class="flex-1 py-2 text-sm font-bold rounded-md text-white bg-slate-700 shadow-sm transition-all">Log In</button>
                    <button onclick="toggleAuthMode('register')" id="tab-register" class="flex-1 py-2 text-sm font-medium text-slate-400 hover:text-white transition-all">Register</button>
                </div>

                <form id="authForm" class="space-y-5">
                    <div id="register-fields" class="hidden space-y-5">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Full Name</label>
                            <input type="text" id="reg-name" class="w-full bg-slate-900/80 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-slate-600" placeholder="John Doe">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Email Address</label>
                        <input type="email" id="email" autocomplete="username" class="w-full bg-slate-900/80 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-slate-600" placeholder="name@example.com">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label>
                        <input type="password" id="password" autocomplete="current-password" class="w-full bg-slate-900/80 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-slate-600" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>

                    <div id="login-options" class="flex items-center justify-between text-sm">
                        <label class="flex items-center cursor-pointer">
                            <input id="rememberMe" type="checkbox" class="w-4 h-4 rounded border-slate-600 bg-slate-800 text-blue-600 focus:ring-offset-slate-900" checked>
                            <span class="ml-2 text-slate-400">Remember me</span>
                        </label>
                    </div>

                    <p id="authError" class="text-red-400 text-sm font-medium text-center hidden bg-red-900/20 py-2 rounded border border-red-900/50">
                        Error Message
                    </p>

                    <button type="submit" id="submitBtn" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-900/20 transition-all transform hover:-translate-y-0.5">
                        LOG IN
                    </button>
                    
                    <p id="reg-note" class="hidden text-xs text-slate-500 text-center leading-relaxed mt-4">
                        By registering, you agree to the research consent form. <br>
                        <span class="text-blue-400">Note: Paid membership features will be locked until payment is verified.</span>
                    </p>
                </form>
            </div>
            
            <div class="mt-8 text-center">
                <a href="index.html" class="text-sm text-slate-500 hover:text-white transition-colors">‚Üê Back to Main Website</a>
            </div>
        </div>
    </section>

    <div id="app-container" class="hidden w-full max-w-4xl mx-auto p-4 pb-20">

        <section id="view-warmup" class="view-section active flex-col gap-6">
            <h2 class="text-2xl font-bold text-white">Step 1: Mobility Prep</h2>
            <p class="text-slate-400 text-sm -mt-4">Please complete this warm-up before assessment.</p>
            
            <div class="glass-panel p-6 rounded-xl border border-slate-700 hover:border-orange-500/50 transition-colors">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-lg font-bold text-white">1. Marching in Place</h3>
                    <span class="bg-slate-800 text-slate-300 text-[10px] font-bold px-2 py-1 rounded uppercase">5 Mins</span>
                </div>
                <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50 text-xs text-slate-400 mb-4">
                    <strong class="text-orange-400 block mb-1">Evidence:</strong>
                    "Low-intensity aerobic activation is a foundational component of effective proprioceptive training programs." (Espejo-Ant√∫nez et al., 2020)
                </div>
                <button class="w-full bg-slate-700 hover:bg-orange-600 text-white py-2 rounded-lg text-sm font-bold transition-colors">Mark Complete</button>
            </div>

            <div class="glass-panel p-6 rounded-xl border border-slate-700 hover:border-orange-500/50 transition-colors">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-lg font-bold text-white">2. Heel & Toe Raises</h3>
                    <span class="bg-slate-800 text-slate-300 text-[10px] font-bold px-2 py-1 rounded uppercase">15 Reps</span>
                </div>
                <p class="text-slate-300 text-sm mb-4">Hold support. Lift toes, then lift heels.</p>
                <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50 text-xs text-slate-400 mb-4">
                    <strong class="text-orange-400 block mb-1">Evidence:</strong>
                    "Ankle dorsiflexor activation is critical for gait stability and fall prevention." (Systematic Review Consensus)
                </div>
                <button class="w-full bg-slate-700 hover:bg-orange-600 text-white py-2 rounded-lg text-sm font-bold transition-colors">Mark Complete</button>
            </div>

            <div class="mt-4 text-center">
                 <button onclick="switchView('assess')" class="w-full bg-slate-800 hover:bg-blue-600 text-white py-4 rounded-xl font-bold transition-all shadow-lg flex items-center justify-center gap-2">
                     Ready for Assessment <span class="text-xl">‚Üí</span>
                 </button>
            </div>
        </section>

        <section id="view-assess" class="view-section flex-col items-center">
            
            <div class="glass-panel p-4 rounded-xl w-full mb-6 text-center border-l-4 border-l-blue-500">
                <h2 id="instructionTitle" class="text-xl font-bold text-white mb-1">Step 2: Mobility Check</h2>
                <p id="instructionText" class="text-slate-400 text-sm">Please position camera for <strong class="text-white">Side-View (Profile), Waist-Down</strong>.</p>
            </div>

            <div class="canvas-wrapper mb-6 relative aspect-[3/4] md:aspect-video w-full max-w-lg mx-auto border border-slate-700">
                <video class="input_video"></video>
                <canvas class="output_canvas"></canvas>
                
                <div class="absolute top-4 left-4 bg-black/60 backdrop-blur px-3 py-1 rounded-full border border-white/10">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse" id="rec-dot" style="display:none"></div>
                        <span class="text-xs font-mono text-white/80">LIVE FEED</span>
                    </div>
                </div>

                <div class="absolute bottom-4 left-0 right-0 text-center">
                    <span class="bg-black/50 text-xs text-slate-300 px-3 py-1 rounded-full backdrop-blur-sm">Privacy Mode: Leg Tracking Only</span>
                </div>

                <div class="absolute inset-0 flex items-center justify-center z-20" id="startOverlay">
                    <button id="startBtn" onclick="initCamera()" class="group relative inline-flex items-center justify-center px-8 py-3 font-bold text-white transition-all duration-200 bg-blue-600 font-lg rounded-full hover:bg-blue-500 hover:shadow-lg hover:shadow-blue-500/40 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-600 ring-offset-slate-900">
                        <span>Activate Sensor</span>
                        <svg class="w-5 h-5 ml-2 -mr-1 transition-transform group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </button>
                </div>
            </div>

            <button id="toggleBtn" onclick="toggleCamera()" class="hidden w-full max-w-lg bg-slate-800 hover:bg-slate-700 text-red-400 border border-slate-700 font-bold py-3 rounded-xl transition-all mb-6">
                Deactivate Camera
            </button>

            <div class="w-full max-w-lg glass-panel rounded-xl p-4">
                <div class="flex justify-between items-center mb-3 border-b border-slate-700 pb-2">
                    <h3 class="text-sm font-bold text-slate-300 uppercase tracking-wide">Session Data</h3>
                    <span class="text-xs text-slate-500 font-mono">ID: <span id="session-id">...</span></span>
                </div>
                <div id="logContainer" class="space-y-1 max-h-32 overflow-y-auto pr-2 custom-scrollbar">
                    <p class="text-slate-600 text-xs italic text-center py-2">Waiting for repetitions...</p>
                </div>
            </div>
            
            <div class="mt-6 text-center">
                 <button onclick="switchView('workout')" class="text-slate-400 hover:text-white flex items-center justify-center gap-2 mx-auto transition-colors">
                     Next: Daily Workout <span class="text-xl">‚Üí</span>
                 </button>
            </div>
        </section>

        <section id="view-workout" class="view-section flex-col gap-6">
            <h2 class="text-2xl font-bold text-white">Step 3: Daily Exercise</h2>
            <p class="text-slate-400 text-sm -mt-4">Protocol based on systematic review consensus (2020-2024).</p>

            <div class="glass-panel p-6 rounded-xl border-l-4 border-l-blue-500 relative">
                <div class="flex justify-between items-start mb-3">
                    <h3 class="text-lg font-bold text-white">1. Sit-to-Stand (Squat)</h3>
                    <span class="bg-blue-900/50 text-blue-300 text-[10px] font-bold px-2 py-1 rounded uppercase">3 x 8 Reps</span>
                </div>
                <p class="text-slate-300 text-sm mb-4">Rise from chair without arms if possible. Control the descent.</p>
                <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50 text-xs text-slate-400 mb-4">
                    <strong class="text-blue-400 block mb-1">Clinical Rationale:</strong>
                    "70-85% of 1RM intensity correlates to 8-12 reps, showing significant improvements in functional independence." (Review Consensus)
                </div>
                <button class="w-full bg-slate-700 hover:bg-green-600 text-white py-2 rounded-lg text-sm font-bold transition-colors">Mark Complete</button>
            </div>

            <div class="glass-panel p-6 rounded-xl border-l-4 border-l-green-500 relative">
                <div class="flex justify-between items-start mb-3">
                    <h3 class="text-lg font-bold text-white">2. Single Leg Stance</h3>
                    <span class="bg-green-900/50 text-green-300 text-[10px] font-bold px-2 py-1 rounded uppercase">20s / Leg</span>
                </div>
                <p class="text-slate-300 text-sm mb-4">Eyes open. Progress to eyes closed if safe.</p>
                <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50 text-xs text-slate-400 mb-4">
                    <strong class="text-green-400 block mb-1">Clinical Rationale:</strong>
                    "Static balance tasks significantly improve stability scores in institutionalized older adults." (Espejo-Ant√∫nez et al., 2020)
                </div>
                <button class="w-full bg-slate-700 hover:bg-green-600 text-white py-2 rounded-lg text-sm font-bold transition-colors">Mark Complete</button>
            </div>

            <div class="glass-panel p-6 rounded-xl border-l-4 border-l-purple-500 relative">
                <div class="flex justify-between items-start mb-3">
                    <h3 class="text-lg font-bold text-white">3. Tandem Walk</h3>
                    <span class="bg-purple-900/50 text-purple-300 text-[10px] font-bold px-2 py-1 rounded uppercase">10 Steps</span>
                </div>
                <p class="text-slate-300 text-sm mb-4">Walk heel-to-toe in a straight line (hallway).</p>
                <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50 text-xs text-slate-400 mb-4">
                    <strong class="text-purple-400 block mb-1">Clinical Rationale:</strong>
                    "Complex gait tasks (multi-directional walking) are superior to simple walking for dynamic balance." (Review Consensus)
                </div>
                <button class="w-full bg-slate-700 hover:bg-green-600 text-white py-2 rounded-lg text-sm font-bold transition-colors">Mark Complete</button>
            </div>
            
            <div class="mt-4 text-center">
                 <button onclick="switchView('food')" class="text-slate-400 hover:text-white inline-flex items-center gap-2 transition-colors">
                     Next: Log Nutrition <span class="text-xl">‚Üí</span>
                 </button>
            </div>
        </section>

        <section id="view-food" class="view-section flex-col gap-6">
            <h2 class="text-2xl font-bold text-white">Step 4: Nutrition Log</h2>
            <p class="text-slate-400 text-sm">Simplified tracking focusing on protein synthesis.</p>

            <div class="glass-panel p-6 rounded-xl">
                <h3 class="text-lg font-bold text-white mb-4">Protein Frequency</h3>
                
                <div class="space-y-3">
                    <label class="flex items-center space-x-3 p-3 bg-slate-900/50 rounded-lg border border-slate-700/50 cursor-pointer hover:bg-slate-800 transition">
                        <input type="checkbox" class="w-5 h-5 text-green-500 rounded focus:ring-green-500 bg-slate-700 border-slate-600">
                        <span class="text-slate-200">Protein at Breakfast</span>
                    </label>
                    <label class="flex items-center space-x-3 p-3 bg-slate-900/50 rounded-lg border border-slate-700/50 cursor-pointer hover:bg-slate-800 transition">
                        <input type="checkbox" class="w-5 h-5 text-green-500 rounded focus:ring-green-500 bg-slate-700 border-slate-600">
                        <span class="text-slate-200">Protein at Lunch</span>
                    </label>
                    <label class="flex items-center space-x-3 p-3 bg-slate-900/50 rounded-lg border border-slate-700/50 cursor-pointer hover:bg-slate-800 transition">
                        <input type="checkbox" class="w-5 h-5 text-green-500 rounded focus:ring-green-500 bg-slate-700 border-slate-600">
                        <span class="text-slate-200">Protein at Dinner</span>
                    </label>
                </div>

                <div class="mt-6 bg-yellow-900/20 p-4 rounded-lg border border-yellow-700/30 text-xs text-slate-300">
                    <strong class="text-yellow-500 block mb-1">Scientific Note:</strong>
                    Anabolic resistance in older muscle requires ~25g-30g of protein per sitting (e.g., a chicken breast or 3 eggs) to effectively trigger muscle protein synthesis.
                </div>
            </div>
            
            <div class="mt-4 text-center">
                 <button onclick="switchView('home')" class="text-slate-400 hover:text-white inline-flex items-center gap-2 transition-colors">
                     Finish: View Stats <span class="text-xl">‚Üí</span>
                 </button>
            </div>
        </section>

        <section id="view-home" class="view-section flex-col gap-6">
            
            <div class="bg-gradient-to-br from-blue-900/40 to-slate-900/40 border border-blue-500/30 p-6 rounded-2xl relative overflow-hidden">
                <div class="relative z-10">
                    <h3 class="text-blue-400 font-bold uppercase tracking-widest text-xs mb-2">Evidence-Based Insight</h3>
                    <p class="text-lg md:text-xl text-slate-100 italic font-serif leading-relaxed">"Resistance training is the most potent non-pharmaceutical intervention for sarcopenia."</p>
                    <p class="text-slate-500 text-xs mt-3">‚Äî Law et al. (2016), <span class="text-slate-400">Journal of Cachexia</span></p>
                </div>
                <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-blue-500/20 rounded-full blur-2xl"></div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="glass-panel p-5 rounded-2xl text-center hover:border-green-500/30 transition-colors">
                    <div class="text-2xl mb-2">üìê</div>
                    <div class="text-2xl font-bold text-white" id="statRom">--</div>
                    <div class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1">Best Mobility</div>
                </div>
                <div class="glass-panel p-5 rounded-2xl text-center hover:border-blue-500/30 transition-colors">
                    <div class="text-2xl mb-2">üèãÔ∏è</div>
                    <div class="text-2xl font-bold text-white" id="statReps">0</div>
                    <div class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1">Total Reps</div>
                </div>
                <div class="glass-panel p-5 rounded-2xl text-center hover:border-orange-500/30 transition-colors">
                    <div class="text-2xl mb-2">üî•</div>
                    <div class="text-2xl font-bold text-white" id="statCals">0</div>
                    <div class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1">Est. Kcals</div>
                </div>
                <div class="glass-panel p-5 rounded-2xl text-center hover:border-purple-500/30 transition-colors">
                    <div class="text-2xl mb-2">üìÖ</div>
                    <div class="text-2xl font-bold text-white" id="statDays">0</div>
                    <div class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1">Day Streak</div>
                </div>
            </div>
            
            <div class="text-center mt-8 p-4 bg-slate-900 rounded-lg">
                <p class="text-white font-bold">You are all caught up for today!</p>
                <p class="text-slate-400 text-sm mt-1">See you tomorrow.</p>
            </div>
        </section>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBYpFeeBu8r1GYBjMzZEuf264pCEU6-6zU",
            authDomain: "rom-tracker-app.firebaseapp.com",
            projectId: "rom-tracker-app",
            storageBucket: "rom-tracker-app.firebasestorage.app",
            messagingSenderId: "133680237142",
            appId: "1:133680237142:web:1a846a2f3a240aca4a09f7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // GLOBAL STATE
        let currentUserId = null;
        let userData = null;
        let isRegistering = false;

        // --- HELPER: Get URL Parameter for Voucher Code ---
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // --- CHECK VOUCHER ---
        // Usage: Share link as app.html?voucher=VIP_ACCESS_2025
        const voucherCode = getQueryParam('voucher');
        if (voucherCode === 'VIP_ACCESS_2025') { 
            setTimeout(() => {
                const note = document.getElementById('reg-note');
                note.innerHTML = `<span class="text-green-400 font-bold">‚úì VIP Access Code Detected.</span><br>Membership fee waived.`;
                note.classList.remove('hidden');
                toggleAuthMode('register'); 
            }, 500);
        }

        // --- AUTH LISTENER ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const docRef = doc(db, "users", user.uid);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        
                        // GATEKEEPER: Check if Paid
                        if (data.paid === true) {
                            currentUserId = user.uid;
                            userData = data;
                            enterApp(userData);
                        } else {
                            showAuthError("Account inactive. Membership required.");
                            signOut(auth);
                        }
                    } else {
                        showAuthError("Profile not found.");
                        signOut(auth);
                    }
                } catch (e) {
                    console.error(e);
                    showAuthError("Connection Error");
                    signOut(auth);
                }
            } else {
                exitApp();
            }
        });

        function enterApp(data) {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            document.getElementById('app-nav').style.display = 'flex';
            loadStats(data);
            document.getElementById('session-id').innerText = Math.random().toString(36).substr(2, 6).toUpperCase();
            
            // START AT WARM UP (STEP 1)
            switchView('warmup');
        }

        function exitApp() {
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('app-nav').style.display = 'none';
            stopCameraLogic();
        }

        // --- AUTH HANDLER ---
        window.toggleAuthMode = function(mode) {
            const loginTab = document.getElementById('tab-login');
            const regTab = document.getElementById('tab-register');
            const regFields = document.getElementById('register-fields');
            const btn = document.getElementById('submitBtn');
            const note = document.getElementById('reg-note');
            const loginOpts = document.getElementById('login-options');

            if (mode === 'register') {
                isRegistering = true;
                loginTab.className = "flex-1 py-2 text-sm font-medium text-slate-400 hover:text-white transition-all";
                regTab.className = "flex-1 py-2 text-sm font-bold rounded-md text-white bg-slate-700 shadow-sm transition-all";
                regFields.classList.remove('hidden');
                btn.innerText = "CREATE ACCOUNT";
                note.classList.remove('hidden');
                loginOpts.classList.add('hidden');
            } else {
                isRegistering = false;
                regTab.className = "flex-1 py-2 text-sm font-medium text-slate-400 hover:text-white transition-all";
                loginTab.className = "flex-1 py-2 text-sm font-bold rounded-md text-white bg-slate-700 shadow-sm transition-all";
                regFields.classList.add('hidden');
                btn.innerText = "LOG IN";
                note.classList.add('hidden');
                loginOpts.classList.remove('hidden');
            }
        }

        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const name = document.getElementById('reg-name').value;
            const err = document.getElementById('authError');
            
            err.classList.add('hidden');
            btn.innerText = "Processing...";
            btn.disabled = true;
            btn.classList.add('opacity-50');

            try {
                await setPersistence(auth, browserLocalPersistence);
                
                if (isRegistering) {
                    // REGISTER FLOW
                    const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                    const user = userCredential.user;
                    
                    // CHECK VOUCHER for VIP status
                    const isVip = (voucherCode === 'VIP_ACCESS_2025'); 

                    // Create Firestore Profile
                    await setDoc(doc(db, "users", user.uid), {
                        email: email,
                        fullName: name,
                        paid: isVip, // <--- Auto-activate if VIP
                        totalReps: 0,
                        totalCalories: 0,
                        bestRom: 0,
                        joinedDate: serverTimestamp()
                    });
                    
                    if (isVip) {
                        // Enter immediately
                        currentUserId = user.uid;
                        userData = { email, fullName: name, paid: true, totalReps: 0, bestRom: 0 };
                        enterApp(userData);
                    } else {
                        // Kick out standard users pending manual payment
                        await signOut(auth);
                        showAuthError("Account created. Pending membership verification.");
                    }

                } else {
                    // LOGIN FLOW
                    await signInWithEmailAndPassword(auth, email, pass);
                }

            } catch (error) {
                console.error(error);
                let msg = "Incorrect Details";
                if (error.code === 'auth/email-already-in-use') msg = "Email already registered.";
                if (error.code === 'auth/weak-password') msg = "Password too weak.";
                showAuthError(msg);
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-50');
                if(!isRegistering) btn.innerText = "LOG IN";
                else btn.innerText = "CREATE ACCOUNT";
            }
        });
        
        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth);
        });

        function showAuthError(msg) {
            const err = document.getElementById('authError');
            err.classList.remove('hidden');
            err.innerText = msg;
        }

        // --- STATS LOGIC ---
        function loadStats(data) {
            document.getElementById('statReps').innerText = data.totalReps || 0;
            document.getElementById('statCals').innerText = data.totalCalories ? Math.round(data.totalCalories) : 0;
            document.getElementById('statRom').innerText = data.bestRom ? data.bestRom + "¬∞" : "--";
            document.getElementById('statDays').innerText = data.daysActive || 1;
        }

        // --- SAVE DATA (Camera) ---
        window.saveSession = async function(reps, depth) {
            if(!currentUserId) return;
            const docRef = doc(db, "users", currentUserId);
            
            const newTotalReps = (userData.totalReps || 0) + reps;
            const newCals = (userData.totalCalories || 0) + (reps * 0.4);
            let newBestRom = userData.bestRom || 180;
            if (depth < newBestRom && depth > 40) newBestRom = depth;

            // Optimistic UI Update
            userData.totalReps = newTotalReps;
            userData.totalCalories = newCals;
            userData.bestRom = newBestRom;
            loadStats(userData);

            await updateDoc(docRef, {
                totalReps: newTotalReps,
                totalCalories: newCals,
                bestRom: newBestRom,
                lastActivity: serverTimestamp(),
                romHistory: arrayUnion(depth)
            });
        }
    </script>

    <script>
        // NAVIGATION
        function switchView(viewName) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));

            document.getElementById(`view-${viewName}`).classList.add('active');
            document.getElementById(`nav-${viewName}`).classList.add('active');

            if (viewName !== 'assess') {
                stopCameraLogic();
            }
        }

        // CAMERA LOGIC
        let cameraInstance = null;
        let isCameraRunning = false;
        let isSquatting = false;
        let currentSquatMin = 180;
        let repCount = 0;
        
        const videoElement = document.getElementsByClassName('input_video')[0];
        const canvasElement = document.getElementsByClassName('output_canvas')[0];
        const canvasCtx = canvasElement.getContext('2d');
        const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
        
        pose.setOptions({modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
        pose.onResults(onResults);

        function stopCameraLogic() {
            if (cameraInstance) {
                cameraInstance.stop();
                isCameraRunning = false;
            }
            document.getElementById('startOverlay').style.display = 'flex';
            document.getElementById('toggleBtn').classList.add('hidden');
            document.getElementById('rec-dot').style.display = 'none';
            document.getElementById('instructionTitle').innerText = "Step 2: Mobility Check";
            document.getElementById('instructionText').innerHTML = "Please position camera for <strong class='text-white'>Side-View (Profile), Waist-Down</strong>.";
        }

        function initCamera() {
            document.getElementById('instructionTitle').innerText = "Initialising Sensor...";
            document.getElementById('instructionText').innerText = "Please allow camera access.";
            document.getElementById('startOverlay').style.display = 'none';
            document.getElementById('toggleBtn').classList.remove('hidden');
            document.getElementById('rec-dot').style.display = 'block';
            
            cameraInstance = new Camera(videoElement, {
                onFrame: async () => { await pose.send({image: videoElement}); },
                width: 1280, height: 720
            });
            cameraInstance.start();
            isCameraRunning = true;
        }

        function toggleCamera() {
            stopCameraLogic();
        }

        function onResults(results) {
            if(!isCameraRunning) return;

            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            
            // Draw image with slight darken filter for better skeleton visibility
            canvasCtx.filter = 'brightness(0.8)';
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.filter = 'none';

            if (results.poseLandmarks) {
                // FILTER: Only draw legs to respect privacy (Visual Feedback)
                // Landmarks: 23-24 (Hips), 25-26 (Knees), 27-28 (Ankles), 29-32 (Feet)
                
                // Define connections for legs only
                const legConnections = [
                    [23, 25], [24, 26], // Hips to Knees
                    [25, 27], [26, 28], // Knees to Ankles
                    [27, 29], [28, 30], // Ankles to Heels
                    [29, 31], [30, 32], // Heels to Toes
                    [23, 24] // Hip to Hip
                ];

                // Draw Connections
                canvasCtx.lineWidth = 2;
                canvasCtx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                for (const [start, end] of legConnections) {
                    const p1 = results.poseLandmarks[start];
                    const p2 = results.poseLandmarks[end];
                    if(p1 && p2 && p1.visibility > 0.5 && p2.visibility > 0.5) {
                        canvasCtx.beginPath();
                        canvasCtx.moveTo(p1.x * canvasElement.width, p1.y * canvasElement.height);
                        canvasCtx.lineTo(p2.x * canvasElement.width, p2.y * canvasElement.height);
                        canvasCtx.stroke();
                    }
                }

                // Draw Landmarks (Dots) for legs only
                canvasCtx.fillStyle = '#60A5FA';
                for (let i = 23; i <= 32; i++) {
                    const p = results.poseLandmarks[i];
                    if(p && p.visibility > 0.5) {
                        canvasCtx.beginPath();
                        canvasCtx.arc(p.x * canvasElement.width, p.y * canvasElement.height, 4, 0, 2 * Math.PI);
                        canvasCtx.fill();
                    }
                }

                const hip = results.poseLandmarks[24];
                const knee = results.poseLandmarks[26];
                const ankle = results.poseLandmarks[28];

                if (hip && knee && ankle && hip.visibility > 0.5) {
                    let radians = Math.atan2(ankle.y - knee.y, ankle.x - knee.x) - Math.atan2(hip.y - knee.y, hip.x - knee.x);
                    let angle = Math.abs(radians * 180.0 / Math.PI);
                    if (angle > 180.0) angle = 360 - angle;
                    angle = Math.round(angle);

                    // Logic & UI Feedback
                    const title = document.getElementById('instructionTitle');
                    const text = document.getElementById('instructionText');

                    if (!isSquatting) {
                        if (angle > 165) {
                            title.innerText = "System Ready";
                            title.className = "text-xl font-bold text-green-400 mb-1";
                            text.innerText = "Perform a squat when ready.";
                        } else {
                            title.innerText = "Stand Tall";
                            title.className = "text-xl font-bold text-yellow-400 mb-1";
                        }
                    } else if (angle < 130) {
                        isSquatting = true;
                        if (angle < currentSquatMin) currentSquatMin = angle;
                        title.innerText = "Recording Depth...";
                        title.className = "text-xl font-bold text-blue-400 mb-1";
                        text.innerText = `Current: ${angle}¬∞`;
                    }

                    if (isSquatting && angle > 165) {
                        // REP COMPLETE
                        repCount++;
                        if (window.saveSession) window.saveSession(1, currentSquatMin);
                        
                        // Add to log
                        const log = document.getElementById('logContainer');
                        const entry = document.createElement("div");
                        entry.className = "flex justify-between items-center text-xs p-2 bg-slate-800/50 rounded border-l-2 border-green-500 mb-1 animate-fade-in";
                        entry.innerHTML = `<span class="font-bold text-white">Rep ${repCount}</span><span class="font-mono text-green-400">${currentSquatMin}¬∞</span>`;
                        log.prepend(entry);

                        // Audio Feedback
                        window.speechSynthesis.cancel();
                        let u = new SpeechSynthesisUtterance(`${currentSquatMin}`);
                        window.speechSynthesis.speak(u);

                        isSquatting = false;
                        currentSquatMin = 180;
                        title.innerText = "Repetition Recorded";
                        title.className = "text-xl font-bold text-white mb-1";
                    }
                }
            }
            canvasCtx.restore();
        }
        
        // Expose to window
        window.switchView = switchView;
        window.initCamera = initCamera;
        window.toggleCamera = toggleCamera;
    </script>
</body>
</html>
